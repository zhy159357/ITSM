<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('编辑隐患排查单')" />
    <th:block th:include="include :: datetimepicker-css" />
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal" id="form-sheet-view" th:object="${checkSheet}">
        <input name="csId" id="csId" th:value="*{csId}" hidden>
        <h4 class="form-header h4">基础信息</h4>
        <div class="row">
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">单号：</label>
                <div class="col-sm-8">
                    <input name="csNo" th:value="*{csNo}" class="form-control" type="text" readonly>
                </div>
            </div>
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">责任处室：</label>
                <div class="col-sm-8">
                    <input name="createOrg"  th:value="${createOrg}" hidden>
                    <input name="createOrgName" class="form-control" th:value="${createOrgName}" readonly type="text">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">责任人：</label>
                <div class="col-sm-8">
                    <input name="createId"   th:value="${createId}" hidden >
                    <input name="createName" class="form-control" th:value="${createName}" readonly type="text">
                </div>
            </div>
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">所属系统：</label>
                <div class="col-sm-8">
                    <input name="sysName" id="sysName" th:value="${sysName}"   class="form-control"   readonly>
                    <input name="sysid" id="sysId"  th:value="*{sysid }"  hidden>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">重要级别：</label>
                <div class="col-sm-8">
                    <select name="importLevel" class="form-control m-b" th:with="type=${@pubParaValue.selectPubParaValueByParaName('CS_LEVEL')}" th:field="*{importLevel}" disabled>
                        <option th:each="dict : ${type}" th:text="${dict.valueDetail}" th:value="${dict.value}"></option>
                    </select>
                </div>
            </div>
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">隐患分类：</label>
                <div class="col-sm-8">
                    <select name="hiddenSort" class="form-control m-b" th:with="type=${@pubParaValue.selectPubParaValueByParaName('CS_TYPE')}" th:value="${hiddenSort}" disabled>
                        <option th:each="dict : ${type}" th:text="${dict.valueDetail}" th:value="${dict.value}"></option>
                    </select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-18">
                <label class="col-sm-2 control-label">隐患描述：</label>
                <div class="col-sm-9">
                    <textarea name="hiddenText" class="form-control" th:field="*{hiddenText}" rows="3" readonly></textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-18">
                <label class="col-sm-2 control-label">影响业务：</label>
                <div class="col-sm-9">
                    <textarea name="affectBusiness" class="form-control" th:field="*{affectBusiness}" rows="3" readonly></textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">最近一次关联故障时间：</label>
                <div class="col-sm-8">
                    <input name="lastTime" class="form-control" th:value="*{lastTime}" placeholder="日期格式为yyyymmdd,没有填'尚未发生'或'频繁发生'" type="text" readonly>
                </div>
            </div>
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">关联问题单号：</label>
                <div class="col-sm-8">
                    <input name="issuefxNo" class="form-control" th:value="*{issuefxNo}" placeholder="如关联问题单请填写问题单号." type="text" readonly>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">是否提交运维建议函：</label>
                <div class="col-sm-8">
                    <select name="maintLetter" class="form-control m-b" th:with="type=${@pubParaValue.selectPubParaValueByParaName('SAFETY_AUDIT')}"  th:field="*{maintLetter}" disabled>
                        <option th:each="dict : ${type}" th:text="${dict.valueDetail}" th:value="${dict.value}"></option>
                    </select>
                </div>
            </div>
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">提示信息：</label>
                <div class="col-sm-8">
                    <input   value="如有提交建议函请在下方添加附件处上传建议函！" class="form-control" type="text" readonly>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">整改单位：</label>
                <div class="col-sm-8">
                    <select name="putUnit" class="form-control m-b" th:with="type=${@pubParaValue.selectPubParaValueByParaName('CS_DEPT')}" th:value="*{putUnit}" disabled>
                        <option th:each="dict : ${type}" th:text="${dict.valueDetail}" th:value="${dict.value}"></option>
                    </select>
                </div>
            </div>
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">分管领导：</label>
                <div class="col-sm-8">
                    <input name="leadId" id="userId0208" th:value="*{leadId}" hidden>
                    <input name="leadName" id="userName0208"   th:value="*{leadName}" class="form-control" type="text" readonly>

                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-18">
                <label class="col-sm-2 control-label">整改建议：</label>
                <div class="col-sm-9">
                    <textarea name="rectProp" rows="3" th:field="*{rectProp}" class="form-control" readonly></textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-18">
                <label class="col-sm-2 control-label">整改进度：</label>
                <div class="col-sm-9">
                    <textarea name="unitSchedule" th:field="*{unitSchedule}" rows="3" class="form-control" readonly></textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">整改实施状态：</label>
                <div class="col-sm-8">
                    <select name="iStatus" class="form-control m-b" th:with="type=${@pubParaValue.selectPubParaValueByParaName('CS_I_STATUS')}" th:field="*{iStatus}" disabled>
                        <option th:each="dict : ${type}" th:text="${dict.valueDetail}" th:value="${dict.value}"></option>
                    </select>
                </div>
            </div>
            <div class="form-group col-sm-6">
                <label class="col-sm-4 control-label">预计解决时间：</label>
                <div class="col-sm-8">
                    <input name="jjTime" class="form-control col-sm-6" th:value="*{jjTime}"  placeholder="日期格式为yyyymmdd,暂时没有解决时间填'不确定'" type="text" readonly>
                </div>
            </div>
        </div>

        <h4 class="form-header h4">审核信息</h4>
        <div class="row">
            <div class="form-group col-sm-18">
                <label class="col-sm-2 control-label">审核意见：</label>
                <div class="col-sm-9">
                    <textarea name="params[comment]" id="comment" rows="3"  class="form-control" maxlength="256" ></textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div class="tabs-container">
                    <ul class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#tab-1" aria-expanded="true">流程记录</a>
                        </li>
                        <li class=""><a data-toggle="tab" href="#tab-2" aria-expanded="false">附件列表</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div id="tab-1" class="tab-pane active">
                            <div class="panel-body">
                                <div class="col-sm-12 select-table table-striped">
                                    <table id="history-table"></table>
                                </div>

                            </div>
                        </div>

                        <div id="tab-2" class="tab-pane">
                            <div class="panel-body">
                                <div class="btn-group-sm" id="toolbar2" role="group">
                                    <a class="btn btn-primary multiple disabled" onclick="downloadFile()">
                                        <i class="fa fa-download"></i> 下载附件
                                    </a>

                                </div>
                                <div class="col-sm-12 select-table table-striped">
                                    <table id="file-table"></table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-offset-5 col-sm-10">
                <button type="button" class="btn btn-sm btn-primary" onclick="submitHandler('0')"><i class="fa fa-check"></i>审核通过</button>&nbsp;
                <button type="button" class="btn btn-sm btn-danger" onclick="submitHandler('1')"><i class="fa fa-reply-all"></i>退回</button>&nbsp;
                <button type="button" class="btn btn-sm btn-danger" onclick="closeItem()"><i class="fa fa-window-close"></i>关 闭 </button>
            </div>
        </div>
    </form>

</div>
<th:block th:include="include :: footer" />
<th:block th:include="include :: datetimepicker-js" />
<script th:src="@{/js/activiti.js}"></script>
<script th:inline="javascript">
    var prefix = ctx + "activiti/sheet"
    $("#form-sheet-add").validate({
        focusCleanup: true
    });
    $(function (){
        puFolwHistory($("#csId").val());
    });
    $(function (){
        $(function() {
            var optionsfj = {
                url: "/pub/attachment/list",
                id:'file-table',
                createUrl: "/pub/attachment/add",
                updateUrl: "/pub/attachment/edit/{id}",
                removeUrl: "/pub/attachment/remove",
                detailUrl: "/pub/attachment/edit/{id}",
                sortName: "fileTime",
                sortOrder: "desc",
                toolbar:"toolbar1",
                singleSelect:true,
                clickToSelect:true,
                queryParams:queryParams,
                modalName: "附件列表",
                columns: [{
                    checkbox: true
                },
                    {
                        field : 'atId',
                        title : '附件ID',
                        visible : false
                    },
                    {
                        field : 'fileName',
                        title : '文件名称'
                    },
                    {
                        field : 'person.pName',
                        title : '上传人'
                    },
                    {
                        field : 'size',
                        title : '文件大小'
                    },
                    {
                        field : 'memo',
                        title : '文件描述'
                    },
                    {
                        field : 'fileTime',
                        title : '上传时间'
                    }]
            };
            $.table.init(optionsfj);
        });

    });
    function queryParams(params) {
        var search = $.table.queryParams(params);
        search.ownerId = $("#csId").val();
        return search;
    }
    function submitHandler(flag){
        if($.common.isNotEmpty($("#comment").val())){
            var data=$("#form-sheet-view").serializeArray()
            var reCode={
                name:'params[reCode]',
                value:flag
            }
            data.push(reCode);
            $.operate.saveTab(prefix+"/shenhe",data);
        }else {
            $.modal.alertWarning("请填审核意见！");
            return;
        }

    }
    /** 关闭选项卡 */
    var closeItem = function(dataId){
        var topWindow = $(window.parent.document);
        if($.common.isNotEmpty(dataId)){
            window.parent.$.modal.closeLoading();
            // 根据dataId关闭指定选项卡
            $('.menuTab[data-id="' + dataId + '"]', topWindow).remove();
            // 移除相应tab对应的内容区
            $('.mainContent .RuoYi_iframe[data-id="' + dataId + '"]', topWindow).remove();
            return;
        }
        var panelUrl = window.frameElement.getAttribute('data-panel');
        $('.page-tabs-content .active i', topWindow).click();
        if($.common.isNotEmpty(panelUrl)){
            $('.menuTab[data-id="' + panelUrl + '"]', topWindow).addClass('active').siblings('.menuTab').removeClass('active');
            $('.mainContent .RuoYi_iframe', topWindow).each(function() {
                if ($(this).data('id') == panelUrl) {
                    $(this).show().siblings('.RuoYi_iframe').hide();
                    return false;
                }
            });
        }
    }
    // 附件下载
    function downloadFile() {
        var rows = $.table.selectFirstColumns();
        var atId = rows[0];
        var ownerId = $("#csId").val();
        var url = ctx + "pub/attachment/download/"+ownerId+"/"+atId;
        window.location.href = url;
    }
</script>
</body>
</html>