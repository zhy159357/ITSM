<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('版本信息')" />
</head>
<body>
    <div class="main-content">
        <form class="form-horizontal m" id="form-taskInfo-confirm" th:object="${vmBizTaskInfo}">
            <input id="taskId" name="taskId" th:field="*{taskId}" type="hidden">
            <input id="versionInfoId" name="versionInfoId" th:field="*{vmBizInfo.versionInfoId}" type="hidden">
            <input name="versionStatus" type="hidden" id="versionStatus" th:value="*{vmBizInfo.versionStatus}"/>
            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">任务单号：</label>
                        <div class="col-sm-8">
                            <input id="taskNo" name="taskNo" th:field="*{taskNo}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">版本编号：</label>
                        <div class="col-sm-8">
                            <input id="versionInfoNo" name="versionInfoNo" th:field="*{vmBizInfo.versionInfoNo}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">任务标题：</label>
                        <div class="col-sm-10">
                            <input id="versionInfoName" name="versionInfoName" th:field="*{vmBizInfo.versionInfoName}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">所属系统：</label>
                        <div class="col-sm-8">
                            <input id="caption" name="caption" th:field="*{vmBizInfo.ogSys.caption}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">版本类型：</label>
                        <div class="col-sm-8">
                            <input id="versionTypeName" name="versionTypeName" th:field="*{vmBizInfo.versionTypeName}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">涉及外围系统：</label>
                        <div class="col-sm-10">
                            <input id="sysName" name="sysName" th:field="*{vmBizInfo.sysName}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">升级内容摘要：</label>
                        <div class="col-sm-10">
                            <textarea rows="10" cols="20" id="versionName" name="versionName" class="form-control" th:text="*{vmBizInfo.versionName}" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">业务需求内容：</label>
                        <div class="col-sm-10">
                            <textarea rows="10" cols="20" id="businessRequirementText" name="businessRequirementText" class="form-control" th:text="*{vmBizInfo.businessRequirementText}" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">功能描述：</label>
                        <div class="col-sm-10">
                            <textarea rows="10" cols="20" id="versionDescription" name="versionDescription" class="form-control" th:text="*{vmBizInfo.versionDescription}" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">涉及模块/服务：</label>
                        <div class="col-sm-10">
                            <textarea rows="10" cols="20" id="issuedNo" name="issuedNo" class="form-control" th:text="*{vmBizInfo.issuedNo}" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">测试要点：</label>
                        <div class="col-sm-10">
                            <textarea rows="10" cols="20" id="businessValidationText" name="businessValidationText" class="form-control" th:text="*{vmBizInfo.businessValidationText}" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">业务测试人员：</label>
                        <div class="col-sm-8">
                            <input id="questionId" name="questionId" placeholder="无" class="form-control" type="text" th:value="*{vmBizInfo.questionId}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">技术测试人员：</label>
                        <div class="col-sm-8">
                            <input id="drafterId" name="drafterId" placeholder="无" class="form-control" type="text" th:value="*{vmBizInfo.drafterId}" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">涉及更新的库：</label>
                        <div class="col-sm-10">
                            <textarea rows="10" cols="20" id="acceptOrganization" name="acceptOrganization" class="form-control" th:text="*{vmBizInfo.acceptOrganization}" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">涉及更新的服务：</label>
                        <div class="col-sm-10">
                            <textarea rows="10" cols="20" id="createunits" name="createunits" class="form-control" th:text="*{vmBizInfo.createunits}" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">涉及重启的服务：</label>
                        <div class="col-sm-10">
                            <textarea rows="10" cols="20" id="copyRequiteUnit" name="copyRequiteUnit" class="form-control" th:text="*{vmBizInfo.copyRequiteUnit}" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">涉及变更的内容：</label>
                        <div class="col-sm-10">
                            <textarea rows="10" cols="20" id="noticeText" name="noticeText" class="form-control" th:text="*{vmBizInfo.noticeText}" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">开始升级时间：</label>
                        <div class="col-sm-8">
                            <input id="actualStartTime" name="actualStartTime" th:field="*{actualStartTime}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">完成升级时间：</label>
                        <div class="col-sm-8">
                            <input id="actualFinishTime" name="actualFinishTime" th:field="*{actualFinishTime}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">任务所属机构：</label>
                        <div class="col-sm-8">
                            <input id="orgName" name="orgName" th:field="*{ogOrg.orgName}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">附件下载人：</label>
                        <div class="col-sm-8">
                            <input id="taskDealUserName" name="taskDealUserName" th:field="*{taskDealUserName}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">确认完成人：</label>
                        <div class="col-sm-8">
                            <input  name="completeUserName" th:field="*{completeUserName}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">确认操作时间：</label>
                        <div class="col-sm-8">
                            <input  name="update_time" th:field="*{update_time}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">升级情况反馈：</label>
                        <div class="col-sm-10">
                            <textarea rows="5" cols="10" id="taskDealResult" name="taskDealResult" class="form-control" th:text="*{taskDealResult}" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">是否引发生产故障：</label>
                        <div class="col-sm-8">
                            <input  name="ifBigFault" th:field="*{ifBigFault}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>

                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">升级结果填报：</label>
                        <div class="col-sm-8">
                            <select id="ifResultSmoothly" name="ifResultSmoothly" class="form-control" th:with="resultSmoothly=${@pubParaValue.selectPubParaValueByParaName('result_smoothly_status')}" th:field="*{ifResultSmoothly}" disabled>
                                <option value=""></option>
                                <option th:each="result : ${resultSmoothly}" th:text="${result.valueDetail}" th:value="${result.value}"></option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">故障情况描述：</label>
                        <div class="col-sm-10">
                            <textarea rows="5" cols="10" id="upgradeMemo" name="upgradeMemo" class="form-control" th:text="*{upgradeMemo}" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">异常或回退内容：</label>
                        <div class="col-sm-10">
                            <textarea rows="5" cols="10" id="backExceptionMemo" name="backExceptionMemo" class="form-control" th:text="*{backExceptionMemo}" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">是否现场支持：</label>
                        <div class="col-sm-10">
                            <input  name="ifSupport" th:field="*{ifSupport}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">升级支持地点：</label>
                        <div class="col-sm-8">
                            <input  name="supportAddress" th:field="*{supportAddress}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>

                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">升级支持人员：</label>
                        <div class="col-sm-8">
                            <input  name="supportPhone" th:field="*{supportPhone}" class="form-control" type="text" readonly>
                        </div>
                    </div>
                </div>
            </div>

        </form>
    </div>


    <div class="row">
        <div class="col-sm-12">
            <div class="tabs-container">
                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#tab-1" aria-expanded="true">任务附件</a>
                    </li>
                    <li class=""><a data-toggle="tab" href="#tab-2" aria-expanded="false">关联发布单</a>
                    </li>
                    <li class=""><a data-toggle="tab" href="#tab-3" aria-expanded="false">自动化执行历史</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div id="tab-1" class="tab-pane active">
                        <div class="panel-body">
                            <div class="btn-group-sm" id="toolbar1" role="group">
                                <a class="btn btn-primary multiple disabled" onclick="taskDownload()">
                                    <i class="fa fa-download"></i> 下载附件
                                </a>
                            </div>
                            <div class="col-sm-12 select-table table-striped">
                                <table id="file-table"></table>
                            </div>
                        </div>
                    </div>

                    <div id="tab-2" class="tab-pane">
                        <div class="panel-body">
                            <div class="btn-group-sm" id="toolbar2" role="group">
                            </div>
                            <div class="col-sm-12 select-table table-striped">
                                <table id="taskInfo-table"></table>
                            </div>
                        </div>
                    </div>

                    <div id="tab-3" class="tab-pane">
                        <div class="panel-body">
                            <div class="btn-group-sm" id="toolbar3" role="group">
                            </div>
                            <div class="col-sm-12 select-table table-striped">
                                <table id="automate-resultMsg"></table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-offset-5 col-sm-10">
            <button class="btn btn-primary" type="button" onclick="window.print()"><i class="fa fa-print"></i>打印</button>&nbsp;
            <button class="btn btn-danger" type="button"  onclick="closeItem()"><i class="fa fa-window-close"></i>关闭</button>
        </div>
    </div>

    <th:block th:include="include :: footer" />
    <!--<th:block th:include="include :: select2-js" />-->
    <th:block th:include="include :: datetimepicker-js" />
    <script th:inline="javascript">
        var prefix = ctx + "version/taskInfo";
        var prefix_public = ctx + "version/public";
        var prefix_attachment = ctx + "pub/attachment";
        var datas = [[${@pubParaValue.selectPubParaValueByParaName('file_type')}]];
        $(function() {
            var options_file = {
                url: prefix_attachment + "/list",
                id: "file-table",
                toolbar:"toolbar1",
                showSearch: false,
                showRefresh: false,
                showToggle: false,
                showColumns: false,
                sortName: "fileTime",
                sortOrder: "desc",
                singleSelect : true,
                clickToSelect: true,
                queryParams:queryParamsFile,
                modalName: "附件列表",
                columns: [{
                    checkbox: true
                },
                    {
                        field : 'atId',
                        title : '附件ID',
                        visible : false
                    },
                    {
                        field : 'fileName',
                        title : '文件名称'
                    },
                    {
                        field : 'person.pName',
                        title : '上传人'
                    },
                    {
                        field : 'size',
                        title : '文件大小'
                    },
                    {
                        field : 'memo',
                        title : '文件描述'
                    },
                    {
                        field : 'fileTime',
                        title : '上传时间',
                        formatter: function (value, row, index) {
                            var startTime = '';
                            if (value != '' && value != null) {
                                var pattern = /(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/;
                                startTime = value.replace(pattern, '$1-$2-$3 $4:$5:$6');
                            }
                            return startTime;
                        }
                    },
                    {
                        field : 'fileType',
                        title : '附件类型',
                        formatter: function(value, row, index) {
                            return $.table.selectPubParaValueData(datas, value);
                        }
                    }]
            };
            $.table.init(options_file);
        });

        $(function (){
            var option_public = {
                url: prefix + "/list",
                id:"taskInfo-table",
                toolbar:"toolbar2",
                showSearch: false,
                showRefresh: false,
                showToggle: false,
                showColumns: false,
                clickToSelect: true,
                queryParams:queryParamsPublic,
                modalName: "关联发布单",
                columns: [{
                    checkbox: true
                },
                    {
                        field : 'versionInfoId',
                        title : '主键ID',
                        visible: false
                    },
                    {
                        field : 'vmBizInfo.versionInfoNo',
                        title : '版本编号',
                        formatter : aFormatter
                    },
                    {
                        field : 'vmBizInfo.versionProducerName',
                        title : '版本发起人'
                    },
                    {
                        field : 'vmBizInfo.versionCreateTime',
                        title : '生成时间'
                    },
                    {
                        field : 'vmBizInfo.versionAttr',
                        title : '版本属性',
                        formatter: function(value, row, index) {
                            return row.versionAttr == '1' ? "版本" : "工具";
                        }
                    },
                    {
                        field: 'vmBizInfo.ogSys.caption',
                        title: '所属系统'
                    }]
            };
            $.table.init(option_public);
        });

        $(function (){
            var option_result = {
                url: prefix + "/automateResultHistory",
                id:"automate-resultMsg",
                toolbar:"toolbar3",
                showSearch: false,
                showRefresh: false,
                showToggle: false,
                showColumns: false,
                clickToSelect: true,
                queryParams:queryParamsResult,
                modalName: "自动化执行历史查询",
                columns: [{
                    checkbox: true
                },
                    {
                        field : 'resultId',
                        title : '主键ID',
                        visible: false
                    },
                    {
                        field : 'businessId',
                        title : '业务单ID',
                        visible: false
                    },
                    {
                        field : 'businessNo',
                        title : '版本单号'
                    },
                    {
                        field : 'attachment.fileName',
                        title : '模版名称'
                    },
                    {
                        field : 'attachment.person.pName',
                        title : '上传人'
                    },
                    {
                        field : 'attachment.fileTime',
                        title : '上传时间',
                        formatter: function (value, row, index) {
                            var startTime = '';
                            if (value != '' && value != null) {
                                var pattern = /(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/;
                                startTime = value.replace(pattern, '$1-$2-$3 $4:$5:$6');
                            }
                            return startTime;
                        }
                    },
                    {
                        field : 'attachment.fileType',
                        title : '附件类型',
                        formatter: function(value, row, index) {
                            return $.table.selectPubParaValueData(datas, value);
                        }
                    },
                    {
                        field : 'startTime',
                        title : '开始时间'
                    },
                    {
                        field : 'endTime',
                        title : '结束时间'
                    },
                    {
                        field : 'status',
                        title : '状态'
                    },
                    {
                        field : 'changeReason',
                        title : '变更原因'
                    }]
            };
            $.table.init(option_result);
        });

        // 附件下载
        function taskDownload() {
            var fileType = $.table.selectColumns("fileType");
            var versionStatus = $("#versionStatus").val();
            if(fileType == "2"){
                $.modal.alert("版本任务详情页面不允许下载版本包！");
                return;
            }
            var rows = $.table.selectFirstColumns();
            var atId = rows[0];
            var ownerId = $("#versionInfoId").val();
            var url = prefix_attachment + "/download/"+ownerId+"/"+atId;
            window.location.href = url;
        }


        // 版本单号超链接跳转到查看版本信息页面
        function aFormatter(value, row, index) {
            var url = prefix_public + "/detail/" + row.versionInfoId;
            return '<a class="btn btn-warning btn-xs" href="javascript:void(0)" onclick="selectDetail(\'' + url + '\')">'+row.vmBizInfo.versionInfoNo+'</a>';
        }

        function selectDetail(url) {
            $.modal.openTab("版本信息",url);
        }

        function queryParamsFile(params) {
            var search = $.table.queryParams(params);
            search.ownerId = $("#versionInfoId").val() == '' ? 'version_taskInfo_detail_no_owner_id' : $("#versionInfoId").val();
            return search;
        }

        function queryParamsPublic(params) {
            var search = $.table.queryParams(params);
            search.taskId = $("#taskId").val();
            search.actualStartTime = "";
            search.actualFinishTime = "";
            search.remark = "versionTaskInfoList";
            return search;
        }

        function queryParamsResult(params) {
            var search = $.table.queryParams(params);
            search.ownerId = $("#versionInfoId").val();
            return search;
        }

    </script>
</body>
</html>