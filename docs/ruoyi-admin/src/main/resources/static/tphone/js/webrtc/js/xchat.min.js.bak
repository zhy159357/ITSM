function XChatKit(e){null==e.fromuser&&(e.fromuser=String.getGUID()),null==e.sendonly&&(e.sendonly=0),null==e.recvonly&&(e.recvonly=0),null==e.videoonly&&(e.videoonly=0),null==e.camera&&(e.camera=0),null==e.h264&&(e.h264=0),null==e.retry&&(e.retry=0),null==e.audiomixer&&(e.audiomixer=1),null==e.imagemixer&&(e.imagemixer=0),null==e.maxwidth&&(e.maxwidth=9999),null==e.maxheight&&(e.maxheight=480),null==e.maxrecwidth&&(e.maxrecwidth=9999),null==e.maxbps&&(e.maxbps=0),null==e.maxbps4recording&&(e.maxbps4recording=0),null==e.flashrate&&(e.flashrate=5),null==e.framerate&&(e.framerate=20),null==e.pipscale&&(e.pipscale=.3),null==e.portrait&&(e.portrait=0),null==e.showpaused&&(e.showpaused=1),null==e.drawingmode&&(e.drawingmode=0),null==e.fixedwidth&&(e.fixedwidth=1280),null==e.fixedheight&&(e.fixedheight=480),null==e.showtime&&(e.showtime=0),null==e.autoleave&&(e.autoleave=0),null==e.vagent&&(e.vagent=0),null==e.statinfo&&(e.statinfo=0),null==e.autoreg&&(e.autoreg=0),null==e.debug&&(e.debug=0),null==e.delayrecord&&(e.delayrecord=3e3),null==e.sharingmode&&(e.sharingmode=1),null==e.password&&(e.password=""),null==e.logoratio&&(e.logoratio="0.2"),null==e.logopos&&(e.logopos="lefttop"),null==e.textpos&&(e.textpos="topcenter"),null==e.textfont&&(e.textfont="20px Verdana"),null==e.textcolor&&(e.textcolor="#fff"),null==e.linewidth&&(e.linewidth="2"),null==e.linetype&&(e.linetype="0"),null==e.linecolor&&(e.linecolor="red"),null==e.samecolor&&(e.samecolor="0"),null==e.virtualbg&&(e.virtualbg="test.jpg"),null==e.ice&&(e.ice="relay"),e.sendonly=parseInt(e.sendonly),e.recvonly=parseInt(e.recvonly),e.videoonly=parseInt(e.videoonly),e.camera=parseInt(e.camera),e.h264=parseInt(e.h264),e.retry=parseInt(e.retry),e.audiomixer=parseInt(e.audiomixer),e.imagemixer=parseInt(e.imagemixer),e.maxwidth=parseInt(e.maxwidth),e.maxheight=parseInt(e.maxheight),e.maxbps=parseInt(e.maxbps),e.maxbps4recording=parseInt(e.maxbps4recording),e.maxrecwidth=parseInt(e.maxrecwidth),e.flashrate=parseInt(e.flashrate),e.framerate=parseInt(e.framerate),e.portrait=parseInt(e.portrait),e.showpaused=parseInt(e.showpaused),e.pipscale=parseFloat(e.pipscale),e.drawingmode=parseInt(e.drawingmode),e.fixedwidth=parseInt(e.fixedwidth),e.fixedheight=parseInt(e.fixedheight),e.showtime=parseInt(e.showtime),e.autoleave=parseInt(e.autoleave),e.vagent=parseInt(e.vagent),e.statinfo=parseInt(e.statinfo),e.autoreg=parseInt(e.autoreg),e.debug=parseInt(e.debug),e.linewidth=parseInt(e.linewidth),e.delayrecord=parseInt(e.delayrecord),e.sharingmode=parseInt(e.sharingmode),e.logoratio=parseFloat(e.logoratio);var t=null;"undefined"!=typeof VConsole&&1==e.debug&&(t=new VConsole),-1==e.debug&&(console.log=function(){}),e.version="v2.0.0-202101192049-com.albert.xchat",console.log("v2.0.0-202101192049-com.albert.xchat"),console.log(JSON.stringify(e));var l=JSON.parse(JSON.stringify(e));delete l.callback,delete l.player,delete l.mp4player,delete l.pdfreader,console.log(JSON.stringify(l));var n=e.mgw,a=e.wphone,o=e.callback,c=e.fromuser,g=e.recorder,r=e.sendonly,s=e.recvonly,d=e.videoonly,O=e.camera,u=e.h264,h=e.retry,v=(e.maxwidth,e.maxheight),m=e.maxrecwidth,p=e.maxbps,f=e.maxbps4recording,S=100/e.flashrate,w=e.framerate,y=e.pipscale,x=e.portrait,b=e.showpaused,C=e.drawingmode,k=e.fixedwidth,N=e.fixedheight,D=e.showtime,I=e.autoleave,R=e.vagent,E=e.statinfo,T=e.debug,M=e.autoreg,J=(e.delayrecord,e.sharingmode),A=e.password,W=e.logoratio,L=e.logopos,P=e.textpos,H=e.textlogo,V=e.textfont,j=e.textcolor,F=e.linewidth,U=e.linetype,_=e.linecolor,q=e.samecolor,G=e.virtualbg,z=e.turn,B=null,Y=null,X=null,$=null,K=null,Z=null,Q=null,ee=null,te=0,oe=0,ie=null,ne=null,ae=null,re=null,se=null,de=null,le=this,ce=0,ge=0,ue=null,he=null,ve=null,me=null,pe=null,fe=null,Se=null,we=null,ye=null,xe=null,be=null,Ce=null,ke=null,Ne=null,Oe=null,De=null,Ie={},Re={},Ee={},Te={},Me=null,Je=null,Ae=null,We=null,Le=null,Pe=null,He=null,Ve=null,je=null,Fe=null,Ue=null,_e=null,qe=1e3/w,Ge=3e3,ze=null,Be=null,Ye=null,Xe=e.player,$e=e.mp4player,Ke=e.pdfreader,Ze=-1<navigator.userAgent.indexOf("iPhone")?1:0,Qe=document.createElement("canvas"),et=document.createElement("canvas"),tt=document.createElement("canvas"),ot=document.createElement("canvas"),it=document.createElement("canvas"),nt=document.createElement("canvas"),at=document.createElement("canvas"),rt=document.createElement("canvas"),st=document.createElement("img"),dt=Qe.getContext("2d"),lt=et.getContext("2d"),ct=tt.getContext("2d"),gt=ot.getContext("2d"),ut=it.getContext("2d"),ht=(nt.getContext("2d"),at.getContext("2d")),vt=rt.getContext("2d"),mt=null,pt=[],ft=!1,St="screen-capture-recorder",wt=e.ice,yt=null,xt=null,bt=null,Ct=null,kt=null,Nt=null;try{st.src="avatar.png"}catch(e){fo(e)}try{e.imagelogo?(mt=new Image).src=e.imagelogo:mt=null}catch(e){fo(e)}"undefined"!=typeof TimelineDataSeries&&l.div4bps&&l.canvas4bps&&(Ct=new TimelineDataSeries,kt=new TimelineGraphView(l.div4bps,l.canvas4bps),Ct.setColor("blue"),kt.setDataSeries([Ct]),kt.updateEndDate()),M&&(oo(),setInterval(function(){io(0)},1e3*M)),R&&(document.body.style="display: none");var Ot=function(e){var t=JSON.parse(JSON.stringify(e));e.stream&&(t.stream=e.stream),!t.chatroom&&ve&&(t.chatroom=ve),!t.fromuser&&c&&(t.fromuser=c),T&&console.debug(JSON.stringify(t)),o&&o(t)};if(Xe||(Xe=document.createElement("video")),Xe.parentNode){var Dt=document.createElement("video");Dt.id=c+"_localvideo",Dt.autoplay="autoplay",Dt.playsinline="playsinline",Dt.volume="0",Dt.style="width:auto;height:1px",Xe.parentNode.appendChild(Dt)}Tt();var It=null,Rt=null,Et=null;function Tt(){navigator.mediaDevices&&navigator.mediaDevices.getSupportedConstraints&&console.log(JSON.stringify(navigator.mediaDevices.getSupportedConstraints())),console.log("loadMediaConstrains"),-1<O?((Q=1==d?{audio:!1,video:{}}:{audio:!0,video:{}}).video=1==x?{height:{exact:v},frameRate:w,advanced:[{aspectRatio:.75}]}:{height:{max:v},frameRate:w},-1<navigator.userAgent.indexOf("Safari")&&-1<navigator.userAgent.indexOf("Version")&&(Q=1==d?{audio:!1,video:{}}:{audio:!0,video:{}})):Q={audio:!0,video:!1},console.log(Q)}if(0==R&&"undefined"!=typeof bodyPix&&!window.tensorNet){It=new Image,Rt=document.createElement("canvas"),Et=Rt.getContext("2d"),It.src=G;bodyPix.load({architecture:"MobileNetV1",outputStride:16,multiplier:.75,quantBytes:2}).then(function(e){console.log("tensorNet loaded"),window.tensorNet=e})}var Mt=null,Jt=null,At=0;function Wt(e){console.log("gotDevices",e);for(var t=0,i=0,o={},n={},a=0;a<e.length;++a){console.log(e[a]),"default"!==e[a].deviceId&&("videoinput"===e[a].kind&&-1<e[a].label.indexOf(St)||("audioinput"===e[a].kind?(o[t]=e[a],t+=1):"videoinput"===e[a].kind&&(n[i]=e[a],i+=1)))}if(console.log("totalMic",t),console.log("totalCamera",i),console.log("audioDevices",o),console.log("videoDevices",n),0==t)return console.log("No audio device"),void(n=o=null);if(0==i)return console.log("No video device"),void(n=o=null);if(1!=i){var r=0;for(a=0;a<i;++a){var s={audio:!0,video:{}};1==d&&(s={audio:!1,video:{}}),s.video.deviceId={exact:n[a].deviceId},navigator.mediaDevices.getUserMedia(s).then(function(e){var t="LocalCamera"+(r+=1),o=document.createElement("video");o.id=t,o.srcObject=e,o.autoplay="autoplay",o.playsinline="playsinline",o.style="width:auto;height:1px",o.volume=0,o.setAttribute("muted",""),o.setAttribute("autoplay",""),o.setAttribute("playsinline",""),Xe.parentNode&&Xe.parentNode.appendChild(o),Ie[t]=new RTCPeerConnection,Ie[t].video=o,Ie[t].stream=e,r==i&&(ye=rt.captureStream(w),e.getAudioTracks().forEach(function(e){console.log("addTrack "+e.kind+" "+e.label),ye.addTrack(e),Se=ye;try{Je||(Je=new AudioMixer),Ae||(Ae=new AudioMixer),Ae.addAudioSource(c,Se),1==l.audiomixer&&Je.addAudioSource(c,Se)}catch(e){console.log(e)}var t=JSON.parse("{}");t.msgtype="EventLocalStream",t.fromuser=c,t.stream=Se,Ot(t),Gt(),oo()}))}).catch(fo)}n=o=null}else Pt(e)}function Lt(e){console.log("getDevices4ScreenCapture",e);for(var t=-1,o=0;o<e.length;++o){if(console.log(e[o].label),"default"!==e[o].deviceId&&"videoinput"===e[o].kind&&-1<e[o].label.indexOf(St)){t=o;break}}if(-1!=t){var i={audio:!1,video:{}};i.video.deviceId={exact:e[t].deviceId},console.log(i);navigator.mediaDevices.getUserMedia(i).then(function(e){Ce=e;var t="LocalScreen",o=document.createElement("video");o.id=t,o.srcObject=e,o.autoplay="autoplay",o.playsinline="playsinline",o.style="width:auto;height:1px",o.volume=0,o.setAttribute("muted",""),o.setAttribute("autoplay",""),o.setAttribute("playsinline",""),o.screencapturerecorder=1,o.hidden=1,Xe.parentNode&&Xe.parentNode.appendChild(o),Ie[t]=new RTCPeerConnection,Ie[t].video=o,Ie[t].stream=e}).catch(fo)}}function Pt(e){console.log("gotDevices",e);for(var t=0,o=0,i={},n={},a=0;a<e.length;++a){console.log(e[a]),"default"!==e[a].deviceId&&("audioinput"===e[a].kind?(i[t]=e[a],t+=1):"videoinput"===e[a].kind&&(n[o]=e[a],o+=1))}if(console.log("totalMic",t),console.log("totalCamera",o),console.log("audioDevices",i),console.log("videoDevices",n),0==t||0==o){var r=JSON.parse("{}");return r.msgtype="EventDeviceError",r.totalmic=t,r.totalcam=o,Ot(r),void(n=i=null)}o<O&&(O=0),console.log("camera",O),console.log("device",n[O]),0<n[O].deviceId.length&&(Q.video.deviceId={exact:n[O].deviceId}),console.log("getUserMedia",Q),navigator.mediaDevices.getUserMedia(Q).then(Ht).catch(fo),n=i=null}function Ht(e){console.log("onGetUserMediaSuccess",e),ye=Se=e;try{Je||(Je=new AudioMixer),Ae||(Ae=new AudioMixer),Ae.addAudioSource(c,Se),1==l.audiomixer&&Je.addAudioSource(c,Se)}catch(e){console.log(e)}var t,o=document.createElement("video");if(o.id=c+"_video",o.srcObject=e,o.style="width:auto;height:1px",o.volume="0",o.setAttribute("muted",""),o.setAttribute("autoplay",""),o.setAttribute("playsinline",""),Ie[c]=new RTCPeerConnection,Ie[c].video=o,Xe.parentNode&&Xe.parentNode.appendChild(o),o.onresize=function(){console.log(c+" size:"+this.videoWidth+"x"+this.videoHeight)},0==ce)return console.log("auto destroy"),void le.Destroy(l);0<l.imagemixer?(Dt.srcObject=Se,(ye=ot.captureStream()).addTrack(Se.getAudioTracks()[0]),Ie[c].video.srcObject=ye,(t=JSON.parse("{}")).msgtype="EventLocalStream",t.fromuser=c,t.stream=ye,Ot(t)):((t=JSON.parse("{}")).msgtype="EventLocalStream",t.fromuser=c,t.stream=Se,Ot(t));Gt(),oo()}function Vt(e){var t;return t=1==r?e.replace(/a=sendrecv\r\n/g,"a=sendonly\r\n"):1==s?e.replace(/a=sendrecv\r\n/g,"a=recvonly\r\n"):e,p&&(t=function(e,t){var o="AS";"firefox"===adapter.browserDetails.browser&&(t=1e3*(t>>>0),o="TIAS");var i=e.indexOf("m=video");if(-1==i)return e;var n=e.substr(0,i),a=e.substr(i);n=-1===n.indexOf("b="+o+":")?n.replace(/c=IN (.*)\r\n/,"c=IN $1\r\nb="+o+":"+t+"\r\n"):n.replace(new RegExp("b="+o+":.*\r\n"),"b="+o+":"+t+"\r\n");a=-1===a.indexOf("b="+o+":")?a.replace(/c=IN (.*)\r\n/,"c=IN $1\r\nb="+o+":"+t+"\r\n"):a.replace(new RegExp("b="+o+":.*\r\n"),"b="+o+":"+t+"\r\n");return e=n+a}(t,p)),t}function jt(e,t,o){if(0==u)return e;if(e.indexOf(t+" ")>e.indexOf(o+" "))return e;for(var i=e.split("\r\n"),n=i.length,a="",r=0;r<n;++r){var s=i[r];-1<s.indexOf("m=video")&&(s=(s=(s=s.replace(t,"xx")).replace(o,t)).replace("xx",o)),a+=s,r<n-1&&(a+="\r\n")}return a}function Ft(n){try{if(!n||!n.getSenders)return;for(var e=n.getSenders(),t=null,o=0;o<e.length;++o)if("audio"===e[o].track.kind&&!e[o].track.peer){t=e[o];break}t&&t.getStats&&t.getStats().then(function(e){e.forEach(function(e){if("audio"===e.kind&&("outboundrtp"!==e.type&&"outbound-rtp"!==e.type||(n.outreport&&e.bytesSent>=n.outreport.bytesSent&&e.timestamp>n.outreport.timestamp&&(n.outbps=((e.bytesSent-n.outreport.bytesSent)/(e.timestamp-n.outreport.timestamp)).toFixed(0)),n.outreport=e)),kt&&(Nt==n||!Nt)&&"outbound-rtp"===e.type&&1!=e.isRemote){Nt||(Nt=n);var t=e.timestamp,o=e.bytesSent;if(n.laststats&&n.laststats.has(e.id)){var i=8*(o-n.laststats.get(e.id).bytesSent)/(t-n.laststats.get(e.id).timestamp);Ct.addPoint(t,i),kt.updateEndDate()}}}),n.laststats=e});var i=n.getReceivers(),a=null;for(o=0;o<i.length;++o)if("audio"===i[o].track.kind){a=i[o];break}a&&a.getStats&&a.getStats().then(function(e){e.forEach(function(e){if("audio"===e.kind&&("inboundrtp"===e.type||"inbound-rtp"===e.type)){var t=e.packetsLost+e.packetsReceived;0<t&&(n.lostratio=(100*e.packetsLost/t).toFixed(2)),n.inreport&&e.bytesReceived>=n.inreport.bytesReceived&&e.timestamp>n.inreport.timestamp&&(n.inbps=((e.bytesReceived-n.inreport.bytesReceived)/(e.timestamp-n.inreport.timestamp)).toFixed(0)),n.inreport=e}})})}catch(e){console.log("updatePeerReport",e)}}function Ut(o){try{if(!o||!o.getSenders)return;for(var e=o.getSenders(),t=null,i=0;i<e.length;++i)if("video"===e[i].track.kind&&!e[i].track.peer){t=e[i];break}t&&t.getStats&&t.getStats().then(function(e){e.forEach(function(e){"video"===e.kind&&("outboundrtp"!==e.type&&"outbound-rtp"!==e.type||(o.voutreport&&e.bytesSent>=o.voutreport.bytesSent&&e.timestamp>o.voutreport.timestamp&&(o.voutbps=((e.bytesSent-o.voutreport.bytesSent)/(e.timestamp-o.voutreport.timestamp)).toFixed(0)),o.voutreport=e))})});var n=o.getReceivers(),a=null;for(i=0;i<n.length;++i)if("video"===n[i].track.kind){a=n[i];break}a&&a.getStats&&a.getStats().then(function(e){e.forEach(function(e){if("video"===e.kind){var t=e.packetsLost+e.packetsReceived;0<t&&(o.vlostratio=(100*e.packetsLost/t).toFixed(2)),"inboundrtp"!==e.type&&"inbound-rtp"!==e.type||(o.vinreport&&e.bytesReceived>=o.vinreport.bytesReceived&&e.timestamp>o.vinreport.timestamp&&(o.vinbps=((e.bytesReceived-o.vinreport.bytesReceived)/(e.timestamp-o.vinreport.timestamp)).toFixed(0)),o.vinreport=e)}})})}catch(e){console.log("updatePeerReport",e)}}function _t(e){var t=JSON.parse("{}");t.msgtype="EventPartyDeleted",t.fromuser=e,t.chatroom=ve,Ot(t)}function qt(){1==E&&function(){try{for(var e in Ie)if(e!=c&&Ie[e]){1==Ie[e].closing&&Ie[e].close(),Ft(Ie[e]),Ut(Ie[e]);var t=JSON.parse("{}");t.msgtype="EventStatInfo",t.fromuser=e,t.in=Ie[e].inbps,t.out=Ie[e].outbps,t.vin=Ie[e].vinbps,t.vout=Ie[e].voutbps,t.lostratio=Ie[e].lostratio,t.vlostratio=Ie[e].vlostratio,t.connectionState=Ie[e].connectionState,t.iceConnectionState=Ie[e].iceConnectionState,t.timestamp=Ie[e].timestamp,1==T&&console.log(JSON.stringify(t)),1==E&&1==ce&&Ot(t)}}catch(e){console.log("fireEventStatInfo",e)}}(),0<h&&function(){try{for(var e in Ie)if(e!=c&&Ie[e]){var t=(new Date).getTime();if(Ie[e].outbps<1&&5e3<t-Ie[e].timestamp){if(Ie[e].timestamp=t,e==g){var o=JSON.parse("{}");o.msgtype="EventRecordingFailed",o.fromuser=e,Ot(o);continue}h-=1,le.ResetWS(),h<1&&(h=l.retry,co(e),_t(e));break}if(Ie[e].inbps<1&&5e3<t-Ie[e].timestamp&&e!=g){Ie[e].timestamp=t,h-=1,le.ResetWS(),h<1&&(h=l.retry,co(e),_t(e));break}}}catch(e){console.log("checkStatInfo",e)}}()}function Gt(){R||(Pe||(Pe=setInterval(zt,qe),we=Qe.captureStream(),0==Ze?Xe.srcObject=we:He=setInterval(Bt,qe)),je||(je=0<k?setInterval(Zt,qe):setInterval(Kt,qe)),!Fe&&2<O&&(Fe=setInterval(Qt,qe)))}function zt(){1==l.imagemixer?function(){var r=null;if(2<O){if((r=Ie.LocalCamera1.video).videoWidth=ot.width,r.videoHeight=ot.height,0==r.videoWidth||!window.tensorNet)return}else if(0==(r=Dt).videoWidth||!window.tensorNet)return;at.width=r.videoWidth,at.height=r.videoHeight,ht.drawImage(r,0,0,r.videoWidth,r.videoHeight,0,0,r.videoWidth,r.videoHeight);window.tensorNet.segmentPerson(at,{flipHorizontal:!1,internalResolution:"medium",segmentationThreshold:.7}).then(function(e){ot.width=r.videoWidth,ot.height=r.videoHeight,ht.drawImage(r,0,0);for(var t=ht.getImageData(0,0,ot.width,ot.height),o=0;o<t.height;++o)for(var i=0;i<t.width;++i){var n=4*o*t.width+4*i,a=o*t.width+i;0==e.data[a]&&(t.data[n+3]=0)}ht.putImageData(t,0,0),ht.globalCompositeOperation="destination-atop",ht.drawImage(It,0,0),gt.drawImage(r,0,0),gt.drawImage(at,0,0)}).catch(function(){})}():11==l.imagemixer?function(){var e=null;if(2<O){if((e=Ie.LocalCamera1.video).videoWidth=ot.width,e.videoHeight=ot.height,0==e.videoWidth||!window.tensorNet)return}else if(0==(e=Dt).videoWidth||!window.tensorNet)return;at.width=e.videoWidth,at.height=e.videoHeight,ot.width=e.videoWidth,ot.height=e.videoHeight,ht.drawImage(e,0,0);for(var t=ht.getImageData(0,0,ot.width,ot.height),o=0;o<t.height;++o)for(var i=0;i<t.width;++i){var n=4*o*t.width+4*i,a=t.data[n],r=t.data[n+1],s=t.data[n+2];a<200&&200<r&&s<200&&(t.data[n+3]=0)}ht.putImageData(t,0,0),ht.globalCompositeOperation="destination-atop",ht.drawImage(It,0,0),gt.drawImage(e,0,0),gt.drawImage(at,0,0)}():2==l.imagemixer?function(){var e=null;if(2<O){if((e=Ie.LocalCamera1.video).videoWidth=ot.width,e.videoHeight=ot.height,0==e.videoWidth||!window.tensorNet)return}else if(0==(e=Dt).videoWidth||!window.tensorNet)return;var t=(new Date).getTime(),o=Rt,i=Et;o.width=e.videoWidth,o.height=e.videoHeight,i.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,o.width,o.height);for(var n=i.getImageData(0,0,o.width,o.height),a=n.data[0],r=n.data[1],s=n.data[2],d=0;d<n.height;++d)for(var l=0;l<n.width;++l){var c=4*d*n.width+4*l,g=n.data[c],u=n.data[c+1],h=n.data[c+2],v=Math.abs(g+u+h-a-r-s);a=g,r=u,s=h,v<20&&(n.data[c+3]=0)}i.putImageData(n,0,0),ot.width=e.videoWidth,ot.height=e.videoHeight,gt.drawImage(Rt,0,0,e.videoWidth,e.videoHeight,0,0,ot.width,ot.height);var m=(new Date).getTime();console.log(m-t)}():3==l.imagemixer?function(){var e=null;if(2<O){if((e=Ie.LocalCamera1.video).videoWidth=ot.width,e.videoHeight=ot.height,0==e.videoWidth||!window.tensorNet)return}else if(0==(e=Dt).videoWidth||!window.tensorNet)return;var t=(new Date).getTime(),o=Rt,i=Et;o.width=e.videoWidth,o.height=e.videoHeight,i.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,o.width,o.height);var n=i.getImageData(0,0,o.width,o.height);if(null==Yt)return Yt=n.data;for(var a=n.data,r=0;r<n.height;++r)for(var s=0;s<n.width;++s){var d=4*r*n.width+4*s,l=n.data[d],c=n.data[d+1],g=n.data[d+2],u=Yt[d],h=Yt[d+1],v=Yt[d+2],m=Math.abs(l+c+g-u-h-v);u=l,h=c,v=g,70<m&&(n.data[d+3]=0)}Yt=a,i.putImageData(n,0,0),ot.width=e.videoWidth,ot.height=e.videoHeight,gt.drawImage(Rt,0,0,e.videoWidth,e.videoHeight,0,0,ot.width,ot.height);var p=(new Date).getTime();console.log(p-t)}():4==l.imagemixer?function(){var e=null;if(2<O){if((e=Ie.LocalCamera1.video).videoWidth=ot.width,e.videoHeight=ot.height,0==e.videoWidth||!window.tensorNet)return}else if(0==(e=Dt).videoWidth||!window.tensorNet)return;(new Date).getTime();var t=Rt,o=Et;t.width=e.videoWidth,t.height=e.videoHeight,o.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,t.width,t.height);var i=o.getImageData(0,0,t.width,t.height);if(null==Yt)return Yt=i.data;for(var n=i.data,a=0;a<i.height;++a)for(var r=0;r<i.width;++r){var s=4*a*i.width+4*r,d=i.data[s],l=i.data[s+1],c=i.data[s+2],g=Yt[s],u=Yt[s+1],h=Yt[s+2],v=Math.abs(d+l+c-g-u-h);g=d,u=l,h=c,v<=80&&(i.data[s+3]=0)}Yt=n,o.putImageData(i,0,0),ot.width=e.videoWidth,ot.height=e.videoHeight,gt.drawImage(Rt,0,0,e.videoWidth,e.videoHeight,0,0,ot.width,ot.height)}():5==l.imagemixer?function(){var e=null;if(2<O){if((e=Ie.LocalCamera1.video).videoWidth=ot.width,e.videoHeight=ot.height,0==e.videoWidth||!window.tensorNet)return}else if(0==(e=Dt).videoWidth||!window.tensorNet)return;(new Date).getTime();var t=Rt,o=Et;t.width=e.videoWidth,t.height=e.videoHeight,o.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,t.width,t.height);var i=o.getImageData(0,0,t.width,t.height);if(null==Yt)return Yt=i.data;for(var n=i.data[0],a=i.data[1],r=i.data[2],s=0;s<i.height;++s)for(var d=0;d<i.width;++d){var l=4*s*i.width+4*d,c=i.data[l],g=i.data[l+1],u=i.data[l+2],h=Math.abs(c-n)+Math.abs(u-r)+Math.abs(g-a);n=c,a=g,r=u,h<10?i.data[l+3]=0:(i.data[l]=255,i.data[l+1]=0,i.data[l+2]=0)}o.putImageData(i,0,0),ot.width=e.videoWidth,ot.height=e.videoHeight,gt.drawImage(Rt,0,0,e.videoWidth,e.videoHeight,0,0,ot.width,ot.height)}():6==l.imagemixer?function(){var e=null;if(2<O){if((e=Ie.LocalCamera1.video).videoWidth=ot.width,e.videoHeight=ot.height,0==e.videoWidth||!window.tensorNet)return}else if(0==(e=Dt).videoWidth||!window.tensorNet)return;(new Date).getTime();var t=Rt,o=Et;t.width=e.videoWidth,t.height=e.videoHeight,o.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,t.width,t.height);var n=o.getImageData(0,0,t.width,t.height);if(null==Yt)return Yt=n.data;for(var a=n.data,r=[],s=[],d=0;d<n.height;++d)for(var l=0;l<n.width;++l){var c=4*d*n.width+4*l,g=n.data[c],u=n.data[c+1],h=n.data[c+2],v=Yt[c],m=Yt[c+1],p=Yt[c+2],f=Math.abs(g-v)+Math.abs(h-p)+Math.abs(u-m);v=g,m=u,p=h,f<=200&&(n.data[c+3]=0)}for(var d=0;d<n.height;++d){for(var S=-1,w=-1,l=0;l<n.width;++l){var c=4*d*n.width+4*l;if(0<n.data[c+3]){S=l;break}}for(var l=n.width;-1<l;--l){var c=4*d*n.width+4*l;if(0<n.data[c+3]){w=l;break}}if(S<w){r.push(S),r.push(d),s.push(w),s.push(d),w;for(var l=S;l<w;++l){var c=4*d*n.width+4*l;n.data[c+3]=255}}}Yt=a,o.fillStyle="red",y=o,x=s,b=!0,C=.5,function(e,t){for(e.beginPath(),e.moveTo(t[0],t[1]),i=2;i<t.length-1;i+=2)e.lineTo(t[i],t[i+1]);e.stroke()}(y,function(e,t,o,i){if(e.length<4)return e;t=t||.5,o=!!o,i=i||16;var n,a,r,s,d,l,c,g,u,h,v,m,p,f=e.slice(0),S=[];for(o?(f.unshift(e[e.length-1]),f.unshift(e[e.length-2]),f.unshift(e[e.length-1]),f.unshift(e[e.length-2]),f.push(e[0]),f.push(e[1])):(f.unshift(e[1]),f.unshift(e[0]),f.push(e[e.length-2]),f.push(e[e.length-1])),p=2;p<f.length-4;p+=2)for(r=(f[p+2]-f[p-2])*t,s=(f[p+4]-f[p-0])*t,d=(f[p+3]-f[p-1])*t,l=(f[p+5]-f[p+1])*t,m=0;m<=i;m++)v=m/i,c=2*Math.pow(v,3)-3*Math.pow(v,2)+1,g=-2*Math.pow(v,3)+3*Math.pow(v,2),u=Math.pow(v,3)-2*Math.pow(v,2)+v,h=Math.pow(v,3)-Math.pow(v,2),n=c*f[p]+g*f[p+2]+u*r+h*s,a=c*f[p+1]+g*f[p+3]+u*d+h*l,S.push(n),S.push(a);return S}(x,C,k,N)),b&&function(e,t){for(var o=0;o<t.length-1;o+=2)e.beginPath(),e.arc(t[o],t[o+1],3,0,2*Math.PI),e.fill()}(y,x),ot.width=e.videoWidth,ot.height=e.videoHeight,gt.drawImage(Rt,0,0,e.videoWidth,e.videoHeight,0,0,ot.width,ot.height);var y,x,b,C,k,N}():7==l.imagemixer&&function(){var e=null;if(2<O){if((e=Ie.LocalCamera1.video).videoWidth=ot.width,e.videoHeight=ot.height,0==e.videoWidth||!window.tensorNet)return}else if(0==(e=Dt).videoWidth||!window.tensorNet)return;(new Date).getTime();var t=Rt,o=Et;t.width=e.videoWidth,t.height=e.videoHeight,o.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,t.width,t.height);for(var i=o.getImageData(0,0,t.width,t.height),n=0;n<i.height;++n)for(var a=0;a<i.width;++a){var r=4*n*i.width+4*a,s=i.data[r],d=i.data[r+1],l=i.data[r+2],c=i.data[r+3],g=(s+d+l)/3;100<g||(i.data[r]=0,i.data[r+1]=0,i.data[r+2]=0,i.data[r+3]=c)}for(var u=i.data[0],h=i.data[1],v=i.data[2],n=0;n<i.height;++n)for(var a=0;a<i.width;++a){var r=4*n*i.width+4*a,m=i.data[r],p=i.data[r+1],f=i.data[r+2],S=Math.abs(m+p+f-u-h-v);u=m,h=p,v=f,S<10&&(i.data[r+3]=0)}o.putImageData(i,0,0),ot.width=e.videoWidth,ot.height=e.videoHeight,gt.drawImage(Rt,0,0,e.videoWidth,e.videoHeight,0,0,ot.width,ot.height)}(),0==C?function(){var e=0,t=0,o=360,i=null,n=null;ze&&Ie[ze]&&Ie[ze].video&&(n=Ie[i=ze].video);for(var a in Ie)if(Ie[a]){var r=Ie[a].video;r&&0!=r.videoWidth&&1!=r.hidden&&1!=r.screencapturerecorder&&(null==n&&a!==c&&(i=a,n=r),r.videoHeight>o&&(o=r.videoHeight))}!n&&Ie[c]&&(n=Ie[i=c].video);if(!n)return;var r=n;if(Qe.height=o,Qe.width=o*r.videoWidth/r.videoHeight,0==Qe.width)return;Qe.width%2==1&&(Qe.width+=1);Qe.height%2==1&&(Qe.height+=1);Be=n.id.replace("_video",""),dt.drawImage(r,0,0,r.videoWidth,r.videoHeight,0,0,Qe.width,Qe.height);var s=Qe.height*(1-y);for(var a in Ie[Be].left=0,Ie[Be].right=Qe.width,Ie[Be].top=0,Ie[Be].bottom=Qe.height*(1-y),Ie)if(Ie[a]&&a!==i){var r=Ie[a].video;r&&0!=r.videoWidth&&1!=r.hidden&&1!=r.screencapturerecorder&&(t=o*y*r.videoWidth/r.videoHeight,dt.drawImage(r,0,0,r.videoWidth,r.videoHeight,e,s,t,o*y),Ie[a].left=e,Ie[a].right=e+t,Ie[a].top=s,Ie[a].bottom=s+o*y,e+=t)}Xt(n.videoWidth,n.videoHeight),$t(),eo()}():1==C?function(){var e=0,t=0,o=360;for(var i in Ie)if(Ie[i]){var n=Ie[i].video;n&&0!=n.videoWidth&&1!=n.hidden&&1!=n.screencapturerecorder&&n.videoHeight>o&&(o=n.videoHeight)}for(var i in Ie)if(Ie[i]){var n=Ie[i].video;n&&0!=n.videoWidth&&1!=n.hidden&&1!=n.screencapturerecorder&&(t+=o*n.videoWidth/n.videoHeight)}Qe.width=t,Qe.height=o,Qe.width%2==1&&(Qe.width+=1);Qe.height%2==1&&(Qe.height+=1);for(var i in Ie)if(Ie[i]){var n=Ie[i].video;n&&0!=n.videoWidth&&1!=n.hidden&&1!=n.screencapturerecorder&&(t=o*n.videoWidth/n.videoHeight,dt.drawImage(n,0,0,n.videoWidth,n.videoHeight,e,0,t,o),i==ze&&(dt.strokeStyle="red",dt.lineWidth=3,dt.strokeRect(e+2,2,t-4,o-4)),Ie[i].left=e,Ie[i].right=e+t,Ie[i].top=0,Ie[i].bottom=o,e+=t)}Xt(Qe.width,Qe.height),$t(),eo()}():2==C?function(){var e=0;for(var t in Ie)if(Ie[t]){var o=Ie[t].video;o&&0!=o.videoWidth&&1!=o.hidden&&1!=o.screencapturerecorder&&(e+=1)}var i=1;i=1==e?1:4<e?3:2;var n=Math.ceil(e/i),a=0,r=0,s=0;for(var t in Qe.width=480*i,Qe.height=360*n,dt.rect(0,0,Qe.width,Qe.height),dt.fillStyle="black",dt.fill(),Ie)if(Ie[t]){var o=Ie[t].video;o&&0!=o.videoWidth&&1!=o.hidden&&1!=o.screencapturerecorder&&(dt.drawImage(o,0,0,o.videoWidth,o.videoHeight,r,s,480,360),Ie[t].left=r,Ie[t].right=r+480,Ie[t].top=s,Ie[t].bottom=s+360,t==ze&&(dt.strokeStyle="red",dt.lineWidth=3,dt.strokeRect(r+2,s+2,476,356)),++a==i?(r=a=0,s+=360):r+=480)}Xt(Qe.width,Qe.height),$t(),eo()}():function(){Qe.height=320*Math.ceil(te/2),Qe.width=1<te?640:320,Qe.width%2==1&&(Qe.width+=1);Qe.height%2==1&&(Qe.height+=1);dt.rect(0,0,Qe.width,Qe.height),dt.fillStyle="black",dt.fill();for(var e=0,t=0,o=0;o<te;++o)t=320*Math.ceil((o+1)/2-1),e=1<te&&o==te-1&&o%2==0?160:o%2*320,dt.drawImage(st,e,t,320,320);Xt(Qe.width,Qe.height),$t()}()}function Bt(){1!=Ze||Xe.posting||(Xe.posting=1,Xe.poster=Qe.toDataURL("image/jpeg",.5),Xe.posting=0)}Xe.onMouseUp=function(e){if(ft&&Xe.onassistance)if(console.log(e),e.offsetX===Mt&&e.offsetY===Jt){var t=(new Date).getTime();(s=JSON.parse("{}")).msgtype=t-At<300?"onDbClick":"onClick",s.fromuser=c,s.chatroom=ve,s.x=e.offsetX/e.target.clientWidth,s.y=e.offsetY/e.target.clientHeight,ao(s),At=t}else{(s=JSON.parse("{}")).msgtype="onDraw",s.fromuser=c,s.chatroom=ve,s.x1=Mt/e.target.clientWidth,s.y1=Jt/e.target.clientHeight,s.x2=e.offsetX/e.target.clientWidth,s.y2=e.offsetY/e.target.clientHeight,s.linewidth=F,s.linetype=U,s.samecolor=q,4==_.length?(s.linered=(parseInt("0x"+_.substring(1,2)+_.substring(1,2),16)/255).toFixed(2),s.linegreen=(parseInt("0x"+_.substring(2,3)+_.substring(2,3),16)/255).toFixed(2),s.lineblue=(parseInt("0x"+_.substring(3,4)+_.substring(3,4),16)/255).toFixed(2)):7==_.length?(s.linered=(parseInt("0x"+_.substring(1,3),16)/255).toFixed(2),s.linegreen=(parseInt("0x"+_.substring(3,5),16)/255).toFixed(2),s.lineblue=(parseInt("0x"+_.substring(5,7),16)/255).toFixed(2)):(s.linered="1.0",s.linegreen="0.0",s.lineblue="0.0"),ao(s)}if(ft&&Xe.onscrawling&&pt.push(null),ft=!1,!Xe.onscrawling&&!Xe.onassistance){var o=Qe.width,i=Qe.height,n=o*e.offsetX/e.target.clientWidth,a=i*e.offsetY/e.target.clientHeight;for(var r in Ie)if(Ie[r]){var s,d=Ie[r].video;if(d&&0!=d.videoWidth&&1!=d.hidden)if(n>Ie[r].left&&n<Ie[r].right&&a>Ie[r].top&&a<Ie[r].bottom)return console.log(r,a,Ie[r].top,Ie[r].bottom),0==Ze&&(Xe.srcObject=we),console.log("ChangeMainPeer",r),ze=r,(s=JSON.parse("{}")).msgtype="EventPeerClicked",s.fromuser=r,s.chatroom=Te[r],void Ot(s)}}},Xe.onMouseDown=function(e){if(ft=!0,Mt=e.offsetX,Jt=e.offsetY,Xe.onscrawling){var t=Qe.height/Xe.style.height.replace("px",""),o={x:e.offsetX*t,y:e.offsetY*t};pt.push(o)}},Xe.onMouseMove=function(e){if(ft&&Xe.onscrawling){var t=Qe.height/Xe.style.height.replace("px",""),o={x:e.offsetX*t,y:e.offsetY*t};pt.push(o)}},Xe.onresize=function(){console.log("player size:"+this.videoWidth+"x"+this.videoHeight)},Xe.onenterpictureinpicture=function(e){Xe.laststyle=videoPlayer.style.cssText,Xe.style.cssText="width:auto;height:1px";var t=JSON.parse("{}");t.msgtype="EventShowFloatingWindow",t.fromuser=c,Ot(t)},Xe.onleavepictureinpicture=function(e){Xe.style=Xe.laststyle,Xe.laststyle=void 0;var t=JSON.parse("{}");t.msgtype="EventHideFloatingWindow",t.fromuser=c,Ot(t)};var Yt=null;function Xt(e,t){if(1==D){var o=(new Date).format()+" "+e+"x"+t;dt.font=V,dt.fillStyle=j;var i=(Qe.width-dt.measureText(o).width)/2,n=dt.measureText("字").width;"bottomcenter"==P?dt.fillText(o,i,Qe.height-2*n):dt.fillText(o,i,n)}if(H){o=H;dt.font=V,dt.fillStyle=j;i=(Qe.width-dt.measureText(o).width)/2,n=dt.measureText("字").width;"bottomcenter"==P?dt.fillText(o,i,Qe.height-n):dt.fillText(o,i,2*n)}if(Be&&Be!=c){var a=Ie[Be];if(!a)return;if(null==a.vinbps||null==a.voutbps||null==a.lostratio||null==a.vlostratio)return;dt.font=V,dt.fillStyle=j;n=dt.measureText("字").width;var r=Qe.height-6*n;dt.fillText("下行kbps:"+String.format(8*a.vinbps,4),0,r),r+=n,dt.fillText("上行kbps:"+String.format(8*a.voutbps,4),0,r),r+=n,dt.fillText("下行kbps:"+String.format(8*a.inbps,4),0,r),r+=n,dt.fillText("上行kbps:"+String.format(8*a.outbps,4),0,r),r+=n,dt.fillText("语音丢包%:"+a.lostratio,0,r),r+=n,dt.fillText("视频丢包%:"+a.vlostratio,0,r)}}function $t(){if(mt){var e=W;"leftbottom"==L?dt.drawImage(mt,0,0,mt.width,mt.height,0,Qe.height-mt.height*e,mt.width*e,mt.height*e):"righttop"==L?dt.drawImage(mt,0,0,mt.width,mt.height,Qe.width-mt.width*e,0,mt.width*e,mt.height*e):"rightbottom"==L?dt.drawImage(mt,0,0,mt.width,mt.height,Qe.width-mt.width*e,Qe.height-mt.height*e,mt.width*e,mt.height*e):"center"==L?dt.drawImage(mt,0,0,mt.width,mt.height,(Qe.width-mt.width*e)/2,(Qe.height-mt.height*e)/2,mt.width*e,mt.height*e):dt.drawImage(mt,0,0,mt.width,mt.height,0,0,mt.width*e,mt.height*e)}S&&(be||K||$)&&(0<=oe?(dt.beginPath(),dt.arc(8,8,8,0,2*Math.PI),dt.fillStyle="red",dt.fill(),++oe>S&&(oe=-1)):oe<0&&--oe<-S&&(oe=0))}function Kt(){var e,t=0,o=360;for(var i in Ie){if(Ie[i])(n=Ie[i].video)&&0!=n.videoHeight&&1!=n.hidden&&n.videoHeight>o&&(o=n.videoHeight)}for(var i in $e&&1==$e.mixed&&$e.videoHeight>o&&(o=$e.videoHeight),Ie){if(Ie[i])(n=Ie[i].video)&&0!=n.videoHeight&&1!=n.hidden&&(t+=o*n.videoWidth/n.videoHeight)}for(var i in $e&&1==$e.mixed&&(t+=o*$e.videoWidth/$e.videoHeight),t=Math.round(t),o=Math.round(o),m<t&&(o=m*o/t,t=m),0==t&&(t=480),0==o&&(o=360),t%2==1&&(t+=1),o%2==1&&(o+=1),tt.width=t,tt.height=o,e=s=0,Ie){var n;if(Ie[i])(n=Ie[i].video)&&0!=n.videoHeight&&1!=n.hidden&&(t=o*n.videoWidth/n.videoHeight,ct.drawImage(n,0,0,n.videoWidth,n.videoHeight,e,s,t,o),e+=t)}if($e&&1==$e.mixed&&0<$e.videoWidth&&0<$e.videoHeight&&(t=o*$e.videoWidth/$e.videoHeight,ct.drawImage($e,0,0,$e.videoWidth,$e.videoHeight,e,s,t,o)),mt){var a=W;"leftbottom"==L?ct.drawImage(mt,0,0,mt.width,mt.height,0,tt.height-mt.height*a,mt.width*a,mt.height*a):"righttop"==L?ct.drawImage(mt,0,0,mt.width,mt.height,tt.width-mt.width*a,0,mt.width*a,mt.height*a):"rightbottom"==L?ct.drawImage(mt,0,0,mt.width,mt.height,tt.width-mt.width*a,tt.height-mt.height*a,mt.width*a,mt.height*a):"center"==L?ct.drawImage(mt,0,0,mt.width,mt.height,(tt.width-mt.width*a)/2,(tt.height-mt.height*a)/2,mt.width*a,mt.height*a):ct.drawImage(mt,0,0,mt.width,mt.height,0,0,mt.width*a,mt.height*a)}if(H){var r=H;dt.font=V,dt.fillStyle=j,e=(tt.width-ct.measureText(r).width)/2,s=tt.height-ct.measureText(r).height,"bottomcenter"==P?ct.fillText(r,e,s):ct.fillText(r,e,20)}r=(new Date).format()+" "+c;ct.font="24px Verdana",ct.fillStyle="#ff0000";var s=ct.measureText("字").width;e=(tt.width-ct.measureText(r).width)/2,ct.fillText(r,e,s)}function Zt(){var e,t=0,o=360;for(var i in Ie){if(Ie[i])(n=Ie[i].video)&&0!=n.videoHeight&&1!=n.hidden&&n.videoHeight>o&&(o=n.videoHeight)}for(var i in $e&&1==$e.mixed&&$e.videoHeight>o&&(o=$e.videoHeight),Ie){if(Ie[i])(n=Ie[i].video)&&0!=n.videoHeight&&1!=n.hidden&&(t+=o*n.videoWidth/n.videoHeight,1)}for(var i in $e&&1==$e.mixed&&(t+=o*$e.videoWidth/$e.videoHeight,1),t=Math.round(t),o=Math.round(o),m<t&&(o=m*o/t,t=m),0==t&&(t=480),0==o&&(o=360),t%2==1&&(t+=1),o%2==1&&(o+=1),et.width=t,et.height=o,e=s=0,Ie){var n;if(Ie[i])(n=Ie[i].video)&&0!=n.videoHeight&&1!=n.hidden&&(t=o*n.videoWidth/n.videoHeight,lt.drawImage(n,0,0,n.videoWidth,n.videoHeight,e,s,t,o),e+=t)}if($e&&1==$e.mixed&&0<$e.videoWidth&&0<$e.videoHeight&&(t=o*$e.videoWidth/$e.videoHeight,lt.drawImage($e,0,0,$e.videoWidth,$e.videoHeight,e,s,t,o)),tt.width=k,tt.height=N,e=(tt.width-et.width)/2,s=(tt.height-et.height)/2,0<=e&&0<=s?ct.drawImage(et,e,s,et.width,et.height):et.width/et.height>tt.width/tt.height?(e=0,s=(tt.height-tt.width*et.height/et.width)/2,ct.drawImage(et,0,0,et.width,et.height,e,s,tt.width,tt.width*et.height/et.width)):(e=(tt.width-tt.height*et.width/et.height)/2,s=0,ct.drawImage(et,0,0,et.width,et.height,e,s,tt.height*et.width/et.height,tt.height)),mt){var a=W;"leftbottom"==L?ct.drawImage(mt,0,0,mt.width,mt.height,0,tt.height-mt.height*a,mt.width*a,mt.height*a):"righttop"==L?ct.drawImage(mt,0,0,mt.width,mt.height,tt.width-mt.width*a,0,mt.width*a,mt.height*a):"rightbottom"==L?ct.drawImage(mt,0,0,mt.width,mt.height,tt.width-mt.width*a,tt.height-mt.height*a,mt.width*a,mt.height*a):"center"==L?ct.drawImage(mt,0,0,mt.width,mt.height,(tt.width-mt.width*a)/2,(tt.height-mt.height*a)/2,mt.width*a,mt.height*a):ct.drawImage(mt,0,0,mt.width,mt.height,0,0,mt.width*a,mt.height*a)}if(H){var r=H;dt.font=V,dt.fillStyle=j,e=(tt.width-ct.measureText(r).width)/2,s=tt.height-ct.measureText(r).height,"bottomcenter"==P?ct.fillText(r,e,s):ct.fillText(r,e,20)}r=(new Date).format()+" "+c;ct.font="24px Verdana",ct.fillStyle="#ff0000";var s=ct.measureText("字").width;e=(tt.width-ct.measureText(r).width)/2,ct.fillText(r,e,s)}function Qt(){var e,t=0,o=360;for(var i in Ie){if(Ie[i])(n=Ie[i].video)&&0!=n.videoHeight&&1!=n.hidden&&1!=n.screencapturerecorder&&-1!=n.id.indexOf("LocalCamera")&&n.videoHeight>o&&(o=n.videoHeight)}for(var i in $e&&1==$e.mixed&&$e.videoHeight>o&&(o=$e.videoHeight),Ie){if(Ie[i])(n=Ie[i].video)&&0!=n.videoHeight&&1!=n.hidden&&1!=n.screencapturerecorder&&-1!=n.id.indexOf("LocalCamera")&&(t+=o*n.videoWidth/n.videoHeight)}for(var i in $e&&1==$e.mixed&&(t+=o*$e.videoWidth/$e.videoHeight),(t=Math.round(t))%2==1&&(t+=1),(o=Math.round(o))%2==1&&(o+=1),0==t&&(t=480),0==o&&(o=360),rt.width=t,rt.height=o,e=0,Ie){var n;if(Ie[i])(n=Ie[i].video)&&0!=n.videoHeight&&1!=n.hidden&&1!=n.screencapturerecorder&&-1!=n.id.indexOf("LocalCamera")&&(t=o*n.videoWidth/n.videoHeight,vt.drawImage(n,0,0,n.videoWidth,n.videoHeight,e,0,t,o),e+=t)}if($e&&1==$e.mixed&&0<$e.videoWidth&&0<$e.videoHeight&&(t=o*$e.videoWidth/$e.videoHeight,vt.drawImage($e,0,0,$e.videoWidth,$e.videoHeight,e,0,t,o)),mt){var a=W;"leftbottom"==L?vt.drawImage(mt,0,0,mt.width,mt.height,0,rt.height-mt.height*a,mt.width*a,mt.height*a):"righttop"==L?vt.drawImage(mt,0,0,mt.width,mt.height,rt.width-mt.width*a,0,mt.width*a,mt.height*a):"rightbottom"==L?vt.drawImage(mt,0,0,mt.width,mt.height,rt.width-mt.width*a,rt.height-mt.height*a,mt.width*a,mt.height*a):"center"==L?vt.drawImage(mt,0,0,mt.width,mt.height,(rt.width-mt.width*a)/2,(rt.height-mt.height*a)/2,mt.width*a,mt.height*a):vt.drawImage(mt,0,0,mt.width,mt.height,0,0,mt.width*a,mt.height*a)}}function eo(){if(0!=pt.length){dt.strokeStyle=_,dt.lineWidth=F,dt.lineJoin="round",dt.lineCap="round";var t=null;pt.forEach(function(e){null!=t&&null!=e&&(dt.beginPath(),dt.moveTo(t.x,t.y),dt.lineTo(e.x,e.y),dt.stroke(),dt.closePath()),t=e})}}function to(){a&&(null===pe||1!=pe.readyState?(console.log("ws.connect",a),(pe=new WebSocket(a)).onopen=function(e){console.log("ws.onopen",a);var t=JSON.parse("{}");t.msgtype="EventConnected2WPhone",t.fromuser=c,Ot(t),se&&se()},pe.onmessage=function(e){var t;"StartServerRecording"==(t=JSON.parse(e.data)).msgtype||"StartCanvasRecording"==t.msgtype?le.StartServerRecording(t):"StopServerRecording"==t.msgtype||"StopCanvasRecording"==t.msgtype?le.StopServerRecording(t):"RestartServerRecording"==t.msgtype||"RestartCanvasRecording"==t.msgtype?le.RestartServerRecording(t):"StartLocalRecording"==t.msgtype?le.StartLocalRecording(t):"StopLocalRecording"==t.msgtype?le.StopLocalRecording(t):"ChangeDrawingMode"==t.msgtype?le.ChangeDrawingMode(t):"JoinConference"==t.msgtype?le.JoinConference(t):"LeaveConferenceEx"==t.msgtype?le.LeaveConferenceEx(t):"HidePeerVideo"==t.msgtype?le.HidePeerVideo(t):"ShowPeerVideo"==t.msgtype?le.ShowPeerVideo(t):"StartVideoPlaying"==t.msgtype?le.StartVideoPlaying(t):"StopVideoPlaying"==t.msgtype?le.StopVideoPlaying(t):"StartSharing"==t.msgtype?le.StartSharing(t):"StopSharing"==t.msgtype?le.StopSharing(t):"EventVisibleWindows"==t.msgtype?le.OnEventEventVisibleWindows(t):"RequestGetState"==t.msgtype?le.GetState(t):"text"==t.msgtype||"RequestSendJson"==t.msgtype?le.SendJSON(t):"EventRegistered"!=t.msgtype&&"EventRecordInfo"!=t.msgtype&&"EventLocalRecordInfo"!=t.msgtype&&"EventJoinSucc"!=t.msgtype&&"EventMgwInfo"!=t.msgtype&&Ot(t)},pe.onclose=function(e){console.log("ws.onclose",a),to()},pe.onerror=function(e){console.log("ws.onerror",a)}):se&&se())}function oo(){n&&(null===fe||1!=fe.readyState?(console.log("ws.connect",n),(fe=new WebSocket(n)).onopen=function(e){console.log("ws.onopen",n),io(1),Le&&(clearInterval(Le),Le=null),Le=setInterval(no,1e3),R||(Ve&&(clearInterval(Ve),Ve=null),Ve=setInterval(qt,1e3))},fe.onmessage=function(e){null!==e.data.size&&0<e.data.size||function(e){console.log("onMsgFromMGW",e),"EventRegistered"==e.msgtype?function(e){console.log("RTT =",(new Date).getTime()-ie),!g&&e.recorder&&(g=e.recorder);e.turnp&&(Y=e.turnp);e.turnu&&(B=e.turnu);e.turn&&!z&&(z=e.turn);e.turnt&&(X=e.turnt);"fs"==e.turnt&&Ie[c]&&Ie[c].video&&(Ie[c].video.hidden=1);Ot(e),ne&&ne()}(e):"EventRegisterFailed"==e.msgtype?(s=e,console.log("RTT =",(new Date).getTime()-ie),Ot(s)):"EventNotifyTalk"==e.msgtype?(console.log("EventNotifyTalk"),Se?(mo(me),me=-1):le.JoinConference(l)):"EventRinging"==e.msgtype?function(e){if(de)return de(e);if("sbc"==X)return me=JSON.parse(JSON.stringify(e)),delete e.content,Ot(e);var t=e.fromuser;Ie[t]&&so(e);console.log("onEventRinging"),mo(e)}(e):"EventEstablished"==e.msgtype?function(e){var t=e.fromuser;if(!Ie[t])return;if(console.log("onEventEstablished"),null===Ie[t].remoteDescription||""===Ie[t].remoteDescription.sdp){var o=JSON.parse("{}");o.type="answer",o.sdp=e.content,t==g&&(o.sdp=jt(e.content,"96","100")),console.log("setRemoteDescription"),o.sdp=Vt(o.sdp),Ie[t].setRemoteDescription(new RTCSessionDescription(o),function(){console.log("setRemoteDescription Success")},fo)}}(e):"EventReleased"==e.msgtype?function(e){if(console.log("onEventReleased"),"fs"==X)return le.Destroy(l);co(e.fromuser);var t=0;for(var o in Ie)o==c||o==g||-1<o.toLowerCase().indexOf("recorder")||(t+=1);0==t&&le.Destroy(l)}(e):"EventPartyAdded"==e.msgtype?ro(e):"EventPartyRemoved"==e.msgtype?(r=e,console.log("onEventPartyRemoved"),co(r.fromuser),Ot(r),R&&le.Destroy(l)):"EventCameraEnabled"==e.msgtype?function(e){console.log("onEventCameraEnabled");var t=e.fromuser;Ie[t]&&Ie[t].video&&(Ie[t].video.hidden=0)}(e):"EventCameraDisabled"==e.msgtype?function(e){if(console.log("onEventCameraDisabled"),1==b)return;var t=e.fromuser;Ie[t]&&Ie[t].video&&(Ie[t].video.hidden=1)}(e):"EventMembersChanged"==e.msgtype?function(e){if(console.log("onEventMembersChanged"),l.rtmp){if(0==ce)return;for(var t=0;t<e.content.length;++t){var o=e.content[t];Ie[o]&&Ie[o].video||vo(o,Ne)}return}-1==O&&(C=-1);Ie[c]&&Ie[c].video&&(Ie[c].video.hidden=2==e.content.length?0:1);te=e.content.length,1==I&&ee&&1<ee.length&&e.content.length<2&&(te=0,le.Destroy(l));ee=e.content,Ot(e),ae&&ae(e)}(e):"EventMemberRemoved"==e.msgtype?(a=e,console.log("onEventMemberRemoved"),co(a.fromuser)):"RequestStartMonitoring"==e.msgtype?function(e){if(!Se)return;console.log("onRequestStartMonitoring"),Oe||(Oe=tt.captureStream()).addTrack(Ae.getAudioTrack());vo(e.fromuser,Oe)}(e):"RequestStopMonitoring"==e.msgtype?function(e){if(!Oe)return;console.log("onRequestStopMonitoring"),co(e.fromuser)}(e):"RequestDisconnect"==e.msgtype?(n=e,console.log("onRequestDisconnect"),le.Destroy(n),(n=JSON.parse("{}")).msgtype="EventDisconnected",n.fromuser=c,Ot(n)):"RequestStartVideoPlaying"==e.msgtype?(i=e,console.log("onRequestStartVideoPlaying"),le.StartVideoPlaying(i)):"RequestStopVideoPlaying"==e.msgtype?(o=e,console.log("onRequestStopVideoPlaying"),le.StopVideoPlaying(o)):"RequestStopVAgent"==e.msgtype?(t=e,console.log("RequestStopVAgent"),t.fromuser=c,le.Destroy(t)):"EventJoinSucc"==e.msgtype?Ot(e):c!=e.fromuser&&Ot(e);var t;var o;var i;var n;var a;var r;var s;if("EventJoinSucc"==e.msgtype){var d=JSON.parse(JSON.stringify(e));d.msgtype="EventMgwInfo",le.Send2WPhone(d),Ot(d)}"onClick"!=e.msgtype&&"onDbClick"!=e.msgtype||le.Send2WPhone(e)}(JSON.parse(e.data))},fe.onclose=function(e){console.log("ws.onclose",n),oo()},fe.onerror=function(e){console.log("ws.onerror",n)}):io(1))}function io(e){var t;e?(t=JSON.parse(JSON.stringify(l))).useragent=navigator.userAgent:t=JSON.parse("{}"),t.msgtype="RequestRegister",t.fromuser=c,t.password=A,t.mgw=n,ie=(new Date).getTime(),ao(t)}function no(){null!==fe&&1==fe.readyState&&fe.send("ping"),null!==pe&&1==pe.readyState&&pe.send("ping")}function ao(e){null!==fe&&1==fe.readyState&&(delete e.callback,delete e.player,delete e.mp4player,delete e.pdfreader,console.log("Send2MGW",e),fe.send(JSON.stringify(e)))}function ro(e){var t=e.fromuser;t==g||-1<t.toLowerCase().indexOf("recorder")||(Ie[t]&&so(e),t!==c&&vo(t,ye),Re[t]=JSON.stringify(e))}function so(e){console.log("onEventPartyRejoined"),co(e.fromuser)}function lo(i,e){for(var n in i)i[n]&&(n==c||n==g||-1<n.toLowerCase().indexOf("recorder")||e.getVideoTracks().forEach(function(e){for(var t=i[n].getSenders(),o=0;o<t.length;++o)if("video"===t[o].track.kind){console.log(t[o]),t[o].replaceTrack(e);break}}))}function co(e){if(console.log("clearPeerConnection",e),Ie[e]&&(Re[e]&&(delete Re[e],Re[e]=null),Te[e]&&(delete Te[e],Te[e]=null),Ie[e].localChannel&&(Ie[e].localChannel.close(),Ie[e].localChannel=null,delete Ie[e].localChannel),Ie[e].dataChannel&&(Ie[e].dataChannel.close(),Ie[e].dataChannel=null,delete Ie[e].dataChannel),Ie[e]==Nt&&(Nt=null,(Ct=new TimelineDataSeries).setColor("blue"),kt.setDataSeries([Ct])),Je&&Je.removeAudioSource(e),Ae&&Ae.removeAudioSource(e),console.log("connectionState",Ie[e].connectionState),console.log("iceConnectionState",Ie[e].iceConnectionState),console.log("iceGatheringState",Ie[e].iceGatheringState),console.log("signalingState",Ie[e].signalingState),Ie[e].stream&&Ie[e].stream.stop(),Ie[e].audio&&(Ie[e].audio.srcObject=null),Ie[e].video&&(Ie[e].video.srcObject=null),Xe.parentNode&&Ie[e].video&&Ie[e].video.parentNode==Xe.parentNode&&Xe.parentNode.removeChild(Ie[e].video),delete Ie[e].video,delete Ie[e].stream,delete Ie[e].candidate,delete Ie[e].timestamp,delete Ie[e].inbps,delete Ie[e].outbps,delete Ie[e].closing,Ie[e].audio=null,Ie[e].video=null,Ie[e].stream=null,Ie[e].candidate=null,Ie[e].timestamp=null,Ie[e].inbps=null,Ie[e].outbps=null,Ie[e].closing=null,Ie[e].close&&(console.log("clearPeerConnection","close"),Ie[e].close()),console.log("clearPeerConnection","delete"),delete Ie[e],Ie[e]=null,delete Ie[e],console.log("clearPeerConnection","success"),go(),e==g)){var t=JSON.parse("{}");t.msgtype="EventRecordingStopped",t.fromuser=e,Ot(t)}}function go(){Se&&console.log("g_localStream",Se),we&&console.log("g_drawingStream",we),xe&&console.log("g_localRecordingStream",xe),be&&console.log("g_serverRecordingStream",be),Oe&&console.log("g_monitoringStream",Oe),Ie&&console.log("g_peerConnections",Object.keys(Ie).length)}function uo(e){for(var t="",o=new Uint8Array(e),i=o.byteLength,n=0;n<i;n++)t+=String.fromCharCode(o[n]);return t}function ho(n){"fs"==X||"sbc"==X||n==g||-1<n.toLowerCase().indexOf("recorder")||(Ie[n].localChannel=Ie[n].createDataChannel(c+"_"+n,{ordered:!0}),Ie[n].localChannel.onopen=function(e){console.log("onLocalChannelOpened",e.target.label),console.log(e)},Ie[n].localChannel.onclose=function(e){console.log("onLocalChannelClosed",e.target.label),console.log(e)},Ie[n].localChannel.onmessage=function(e){console.log("onLocalChannelMessage",e.target.label),console.log(e)},Ie[n].ondatachannel=function(e){console.log("onRemoteDataChannel",e.target.label),console.log(e),Ie[n].dataChannel=e.channel,Ie[n].dataChannel.onopen=function(e){console.log("onRemoteChannelOpened",e.target.label),console.log(e),Ye=""},Ie[n].dataChannel.onclose=function(e){console.log("onRemoteChannelClosed"),console.log(e)},Ie[n].dataChannel.onmessage=function(e){if(console.log("onRemoteChannelMessage",e.target.label),console.log(e),9==e.data.byteLength&&"LastFrame"==uo(e.data)){var t,o="data:image/png;base64,"+(t=Ye,window.btoa(t));Ye="";var i=JSON.parse("{}");i.msgtype="EventPhotoTaken",i.chatroom=ve,i.fromuser=n,i.content=o,Ot(i)}else Ye+=uo(e.data)}})}function vo(n,t){if(Ie[n]&&co(n),"fs"==X&&-1<navigator.userAgent.indexOf("Firefox"))console.log("createPeerConnection",n),Ie[n]=new RTCPeerConnection;else if(z){(R&&n==g||-1<n.toLowerCase().indexOf("recorder"))&&"turn:127.0.0.1:3478";var e={iceServers:[{urls:z,username:B,credential:Y,credentialType:"password"}],iceTransportPolicy:wt,sdpSemantics:"plan-b"};console.log("createPeerConnection",n),Ie[n]=new RTCPeerConnection(e)}else{e={iceServers:[{urls:"stun:115.159.147.191"}],sdpSemantics:"plan-b"};"sbc"!=X&&delete e.iceServers,console.log("createPeerConnection",n),Ie[n]=new RTCPeerConnection(e)}t.getAudioTracks().forEach(function(e){console.log("addTrack "+e.kind+" "+e.label),Ie[n].addTrack(e,t)}),-2==O?n==g?be.getVideoTracks().forEach(function(e){console.log("addTrack "+e.kind+" "+e.label),Ie[n].addTrack(e,be)}):(ye=Ne).getVideoTracks().forEach(function(e){console.log("addTrack "+e.kind+" "+e.label),Ie[n].addTrack(e,Ne)}):(-1<O||-3==O)&&t.getVideoTracks().forEach(function(e){console.log("addTrack "+e.kind+" "+e.label),Ie[n].addTrack(e,t)}),Ie[n].ontrack=function(e){po(n,e)},delete Ie[n].inreport,delete Ie[n].outreport,Ie[n].inbps=0,Ie[n].outbps=0,Ie[n].timestamp=(new Date).getTime(),Ie[n].onicegatheringstatechange=function(e){if(console.log("onicegatheringstatechange:",this.iceGatheringState),"complete"==this.iceGatheringState&&(!z||-1<navigator.userAgent.indexOf("Firefox"))){var t=JSON.parse(JSON.stringify(l));t.msgtype="RequestMakeCall",t.chatroom=ve,t.fromuser=c,t.touser=n,t.content=jt(Ie[n].localDescription.sdp,"96","127"),ao(t)}},ho(n),Ie[n].createOffer(function(e){console.log("createOffer Success"),e.sdp=Vt(e.sdp),delete Ie[n].candidate,Ie[n].setLocalDescription(e,function(){console.log("setLocalDescription Success")},fo),Ie[n].oniceconnectionstatechange=function(e){onIceConnectionStateChange(n)},Ie[n].onicecandidate=function(e){if(!("fs"==X&&-1<navigator.userAgent.indexOf("Firefox")||null==z||0==z.length||null===e.candidate||0!==e.candidate.sdpMLineIndex||Ie[n].candidate)){Ie[n].candidate=e.candidate.candidate;var t=function(e){for(var t=Ie[e].getSenders(),o=0;o<t.length;++o)if("video"===t[o].track.kind)return!0;return!1}(n)?3:2,o=(new Date).getTime(),i=setInterval(function(){if(Ie[n]){if(Ie[n].localDescription.sdp.split("typ relay raddr").length>=t||1e3<(new Date).getTime()-o){clearInterval(i);var e=JSON.parse(JSON.stringify(l));e.msgtype="RequestMakeCall",e.chatroom=ve,e.fromuser=c,e.touser=n,e.content=jt(Ie[n].localDescription.sdp,"96","127"),ao(e)}}else clearInterval(i)},100)}}},fo)}function mo(e){if(Se){var i=e.fromuser;if(z){var t={iceServers:[{urls:z,username:B,credential:Y,credentialType:"password"}],iceTransportPolicy:wt,sdpSemantics:"plan-b"};console.log("createPeerConnection",i),Ie[i]=new RTCPeerConnection(t)}else{t={iceServers:[{urls:"stun:115.159.147.191"}],sdpSemantics:"plan-b"};"sbc"!=X&&delete t.iceServers,console.log("createPeerConnection",i),Ie[i]=new RTCPeerConnection(t)}Se.getAudioTracks().forEach(function(e){console.log("addTrack "+e.kind+" "+e.label),Ie[i].addTrack(e,Se)}),-2==O?(ye=Ne).getVideoTracks().forEach(function(e){console.log("addTrack "+e.kind+" "+e.label),Ie[i].addTrack(e,Ne)}):(-1<O||-3==O)&&ye.getVideoTracks().forEach(function(e){console.log("addTrack "+e.kind+" "+e.label),Ie[i].addTrack(e,ye)}),Ie[i].ontrack=function(e){po(i,e)},Ie[i].oniceconnectionstatechange=function(e){onIceConnectionStateChange(i)},Ie[i].onicegatheringstatechange=function(e){if(console.log("onicegatheringstatechange:",this.iceGatheringState),!z&&"complete"==this.iceGatheringState){var t=JSON.parse(JSON.stringify(l));t.msgtype="RequestAnswerCall",t.chatroom=ve,t.fromuser=c,t.touser=i,t.content=Ie[i].localDescription.sdp,ao(t)}},delete Ie[i].candidate,Ie[i].onicecandidate=function(e){if(null!=z&&0!=z.length&&null!==e.candidate&&0===e.candidate.sdpMLineIndex&&!Ie[i].candidate){Ie[i].candidate=e.candidate.candidate;var t=(new Date).getTime(),o=setInterval(function(){if(Ie[i]){if(2<=Ie[i].localDescription.sdp.split("typ relay raddr").length||1e3<(new Date).getTime()-t){clearInterval(o);var e=JSON.parse(JSON.stringify(l));e.msgtype="RequestAnswerCall",e.chatroom=ve,e.fromuser=c,e.touser=i,e.content=Ie[i].localDescription.sdp,ao(e)}}else clearInterval(o)},100)}},ho(i);var o=JSON.parse("{}");o.type="offer",o.sdp=jt(e.content,"96","98"),delete Ie[i].inreport,delete Ie[i].outreport,Ie[i].inbps=0,Ie[i].outbps=0,Ie[i].timestamp=(new Date).getTime(),Ie[i].setRemoteDescription(new RTCSessionDescription(o),function(){console.log("setRemoteDescription Success"),Ie[i].createAnswer(function(e){console.log("createAnswer Success"),e.sdp=Vt(e.sdp),e.sdp=jt(e.sdp,"96","127"),Ie[i].setLocalDescription(e,function(){console.log("setLocalDescription Success")},fo)},fo)},fo)}}function po(e,t){if(R){"audio"==t.track.kind?((i=document.createElement("audio")).id=e+"_audio",i.srcObject=t.streams[0],i.autoplay="autoplay",Ie[e].audio=i,Je||(Je=new AudioMixer),Je.addAudioSource(e,t.streams[0],i)):e!=c&&(be=t.streams[0],vo(g,be))}else{if(t.track.peer=e,console.log("onTrackAdded",t.track),"audio"===t.track.kind){(a=Re[e]?JSON.parse(Re[e]):JSON.parse("{}")).msgtype="EventPartyAdded",a.fromuser=e,a.streamtype="audio",a.stream=t.streams[0],Ot(a);var o=[];o.push(c),o.push(e);var i,n=JSON.parse(JSON.stringify(a));return n.msgtype="EventMembersChanged",n.content=o,Ot(n),(i=document.createElement("audio")).id=e+"_audio",i.srcObject=t.streams[0],i.autoplay="autoplay",Ie[e].audio=i,l.rtmp&&e==c&&(i.volume="0"),Je||(Je=new AudioMixer),Ae||(Ae=new AudioMixer),Je.addAudioSource(e,t.streams[0],i),void Ae.addAudioSource(e,t.streams[0].clone(),i)}if(!Ie[e].stream){var a;console.log("onRemoteStreamReady "+t.streams[0].id),Ie[e].stream=t.streams[0],(a=Re[e]?JSON.parse(Re[e]):JSON.parse("{}")).msgtype="EventPartyAdded",a.streamtype="video",a.fromuser=e,a.stream=t.streams[0],Ot(a);var r=document.createElement("video");r.id=e+"_video",r.srcObject=t.streams[0],r.style="width:auto;height:1px",r.setAttribute("autoplay",""),r.setAttribute("playsinline",""),Ie[e].video=r,Xe.parentNode.appendChild(r),l.rtmp&&e==c&&(r.volume="0"),r.onresize=function(){console.log(e+" size:"+this.videoWidth+"x"+this.videoHeight)}}}}function fo(e){if(console.log("%conError"+e.name,"color:#f00;"),"NotFoundError"==e.name)(t=JSON.parse("{}")).msgtype="EventDeviceNotFound",t.content=e.name,Ot(t);else if("NotAllowedError"==e.name){(t=JSON.parse("{}")).msgtype="EventDeviceDisabled",t.content=e.name,Ot(t)}else{var t;(t=JSON.parse("{}")).msgtype="EventError",t.content=e,Ot(t)}}function So(e){for(var t=-1,o=0;o<e.length;++o){console.log(e[o].label),"default"!==e[o].deviceId&&("videoinput"===e[o].kind&&-1<e[o].label.indexOf(St)&&(t=o))}if(-1==t){var i=JSON.parse("{}");i.msgtype="EventCameraNotFound",i.content=St,Ot(i)}var n={audio:!1,video:{}};-1<t&&(n.video.deviceId={exact:e[t].deviceId}),navigator.mediaDevices.getUserMedia(n).then(re).catch(fo)}function wo(e){var t;console.log("onGetScreenSuccess",e),(window.screenStream=e).oninactive=function(e){le.StopSharing();var t=JSON.parse("{}");t.msgtype="EventStopSharing",t.fromuser=c,Ot(t)},(t=JSON.parse("{}")).msgtype="EventLocalStream",t.fromuser=c,t.stream=e,Ot(t),(t=JSON.parse("{}")).msgtype="EventStartSharing",t.fromuser=c,t.stream=e,Ot(t),Ie[c]&&Ie[c].video?Ie[c].video.srcObject=e:Ie.LocalCamera2&&Ie.LocalCamera2.video&&(Ie.LocalCamera2.video.srcObject=e),lo(window.peerConnections,window.screenStream),delete window.peerConnections,le.ChangeLayout("1"),le.ChangeSpeaker(c)}function yo(e){console.log(e),console.log("%conError4Sharing:"+e.name,"color:#f00;")}function xo(e){if(e.data.sourceId){var t={mandatory:{chromeMediaSource:"desktop"}};t.mandatory.chromeMediaSourceId=e.data.sourceId,navigator.mediaDevices.getUserMedia({video:t}).then(wo).catch(yo)}}function bo(){html2canvas(document.body,{logging:!1}).then(function(e){it.width=.5*e.width,it.height=.5*e.height,ut.drawImage(e,0,0,e.width,e.height,0,0,it.width,it.height)})}function Co(e){console.log("gotDevices",e);for(var t=0,n=0,o={},i={},a=0;a<e.length;++a){console.log(e[a]),"default"!==e[a].deviceId&&("audioinput"===e[a].kind?(o[t]=e[a],t+=1):"videoinput"===e[a].kind&&(i[n]=e[a],n+=1))}if(console.log("totalMic",t),console.log("totalCamera",n),console.log("audioDevices",o),console.log("videoDevices",i),0==t)return console.log("No audio device"),void(i=o=null);if(0==n)return console.log("No video device"),void(i=o=null);var r=0;for(a=0;a<n;++a){var s={audio:!0,video:{}};1==d&&(s={audio:!1,video:{}}),s.video.deviceId={exact:i[a].deviceId},navigator.mediaDevices.getUserMedia(s).then(function(e){var t="LocalCamera"+(r+=1),o=document.createElement("video");if(o.id=t,o.srcObject=e,o.autoplay="autoplay",o.playsinline="playsinline",o.style="width:auto;height:1px",o.volume=0,o.setAttribute("muted",""),o.setAttribute("autoplay",""),o.setAttribute("playsinline",""),Xe.parentNode&&Xe.parentNode.appendChild(o),Ie[t]=new RTCPeerConnection,Ie[t].video=o,Ie[t].stream=e,r==n){Gt(),xe=tt.captureStream(w),e.getAudioTracks().forEach(function(e){console.log("addTrack "+e.kind+" "+e.label),xe.addTrack(e)});var i=l.filename?l.filename:c+"_"+(new Date).getTime()+".mp4";($=RecordRTC(xe,{type:"video",mimeType:"video/mp4",disableLogs:!1,getNativeBlob:!1})).setFileName(i),$.startRecording()}}).catch(fo)}i=o=null}function ko(e){var t=setInterval(function(){clearInterval(t),Ot(e)},Ge)}function No(e){console.log("gotDevices",e);for(var t,o=0,i=0,n={},a={},r=0;r<e.length;++r){console.log(e[r]),"default"!=e[r].deviceId&&("videoinput"==e[r].kind&&-1<e[r].label.indexOf(St)||("audioinput"==e[r].kind?(n[o]=e[r],o+=1):"videoinput"==e[r].kind&&(a[i]=e[r],i+=1)))}return console.log("totalMic",o),console.log("totalCamera",i),console.log("audioDevices",n),console.log("videoDevices",a),a=n=null,0==o?((t=JSON.parse("{}")).msgtype="EventMicphoneNotFound",t.totalmic=o,t.totalcam=i,void ko(t)):0==i?((t=JSON.parse("{}")).msgtype="EventCameraNotFound",t.totalmic=o,t.totalcam=i,void ko(t)):void navigator.mediaDevices.getUserMedia(Q).then(Do).catch(Oo)}function Oo(e){console.log("onCheckError",e);var t=JSON.parse("{}");t.msgtype="EventDeviceDisabled",t.content=e.name,ko(t)}function Do(t){console.log("onSelfCheck"),window.soundLevel=0,Me=new SoundMeter(t);var o=setInterval(function(){var e;(clearInterval(o),Me&&(Me.destroy(),Me=null),t.stop(),0<window.soundLevel)?((e=JSON.parse("{}")).msgtype="EventSelfCheck",e.volume=window.soundLevel,e.audiotracks=t.getAudioTracks().length,e.videotracks=t.getVideoTracks().length,Ot(e)):((e=JSON.parse("{}")).msgtype="EventMicphoneMuted",Ot(e))},Ge)}function Io(e){console.log("gotDevices",e);for(var o=[],t=0;t<e.length;++t)"default"!=e[t].deviceId&&"videoinput"==e[t].kind&&o.push(e[t].label);if(console.log("videoDevices",o),0==o.length){var i=JSON.parse("{}");return i.msgtype="EventCameraNotFound",void ko(i)}var n=[];navigator.mediaDevices.getUserMedia({audio:!1,video:{width:{exact:1280},height:{exact:720}}}).then(function(e){e.stop(),n.push("1280x720"),n.push("640x480"),n.push("320x240"),n.push("160x120");var t=JSON.parse("{}");t.msgtype="EventCamerasInfo",t.count=o.length,t.cameras=o,t.supported=n,Ot(t)}).catch(function(){n.push("640x480"),n.push("320x240"),n.push("160x120");var e=JSON.parse("{}");e.msgtype="EventCamerasInfo",e.count=o.length,e.cameras=o,e.supported=n,Ot(e)})}function Ro(e){console.log("onCameraTest",e),l.imagemixer=0,ue=(Se=e).getVideoTracks()[0].label,he=e.getAudioTracks()[0].label;var t=JSON.parse("{}");t.msgtype="EventLocalStream",t.fromuser=c,t.stream=Se,Ot(t);var o=document.createElement("video");o.id=c+"_video",o.srcObject=e,o.style="width:auto;height:1px",o.volume="0",o.setAttribute("muted",""),o.setAttribute("autoplay",""),o.setAttribute("playsinline",""),Ie[c]=new RTCPeerConnection,Ie[c].video=o,Xe.parentNode&&Xe.parentNode.appendChild(o),Gt(),to()}function Eo(e){console.log("onStartVPR",e),Se=e,Xe.srcObject=e;var t=JSON.parse("{}");t.msgtype="EventLocalStream",t.fromuser=c,t.stream=e,Ot(t),(Z=RecordRTC(Se,{type:"audio",recorderType:StereoAudioRecorder,numberOfAudioChannels:1,desiredSampRate:8e3})).startRecording(),-1!=navigator.userAgent.indexOf("Safari")&&-1!=navigator.userAgent.indexOf("Version")||(yt=document.createElement("canvas"),xt=yt.getContext("2d"),yt.style="display:none;",Xe.laststyle=Xe.style.cssText,Xe.parentNode&&Xe.parentNode.appendChild(yt),g_timerTracker=setInterval(function(){var e=Xe,t=document.createElement("canvas"),o=t.getContext("2d");t.width=.5*e.videoWidth,t.height=.5*e.videoHeight,o.drawImage(e,0,0,t.width,t.height);var i=t.toDataURL("image/jpeg",.5),n=document.createElement("img");n.src=i,n.onload=function(){var e=new tracking.ObjectTracker(["face"]);e.setInitialScale(4),e.setStepSize(2),e.setEdgesDensity(.1),tracking.track(n,e),e.on("track",function(e){if(0<e.data.length){bt||(Xe.style="width:auto; height:360px;z-index:0;position:absolute;margin-left:-250px",yt.style="width:100px;height:100px;z-index:1;position:absolute;margin-left:-250px;");var t=e.data[0];yt.width=t.width,yt.height=t.height,xt.drawImage(n,t.x,t.y-10,t.width,t.height+20,0,0,t.width,t.height),bt=yt.toDataURL("image/jpeg",.5)}})}},100))}this.PauseAR=function(){g_lastPoints=g_currPoints},onIceConnectionStateChange=function(i){if(Ie[i])if(console.log("oniceconnectionstatechange:"+Ie[i].iceConnectionState),"connected"==Ie[i].iceConnectionState){if(Ie[i].inbps=0,Ie[i].outbps=0,Ie[i].closing=0,(n=JSON.parse("{}")).msgtype="EventPartyConnected",n.fromuser=i,Ot(n),i==g)(n=JSON.parse("{}")).msgtype="EventRecordingStarted",n.fromuser=i,Ot(n);if(p)for(var e=Ie[i].getSenders(),t=0;t<e.length;++t)if("video"===e[t].track.kind){console.log(e[t]),(o=e[t].getParameters()).encodings&&o.encodings[0]||(o.encodings=[{}]),0==p?delete o.encodings[0].maxBitrate:o.encodings[0].maxBitrate=1e3*p;break}if(i==g)for(e=Ie[g].getSenders(),t=0;t<e.length;++t)if("video"===e[t].track.kind){var o;console.log(e[t]),(o=e[t].getParameters()).encodings&&o.encodings[0]||(o.encodings=[{}]),0==f?delete o.encodings[0].maxBitrate:o.encodings[0].maxBitrate=1e3*f,e[t].setParameters(o);break}i!=g&&window.screenStream&&window.screenStream.getVideoTracks().forEach(function(e){for(var t=Ie[i].getSenders(),o=0;o<t.length;++o)if(console.log(t[o]),"video"===t[o].track.kind){console.log("replaceTrack",e),t[o].replaceTrack(e);break}})}else if("closed"==Ie[i].iceConnectionState){Ie[i].inbps=0,Ie[i].outbps=0,Ie[i].closing=0,(n=JSON.parse("{}")).msgtype="EventPartyClosed",n.fromuser=i,Ot(n)}else if("disconnected"==Ie[i].iceConnectionState){if(Ie[i].inbps=0,Ie[i].outbps=0,Ie[i].closing=1,Ie[i].video&&(Ie[i].video.srcObject=null),Ie[i].audio&&(Ie[i].audio.srcObject=null),(n=JSON.parse("{}")).msgtype="EventPartyDisconnected",n.fromuser=i,Ot(n),i==g)(n=JSON.parse("{}")).msgtype="EventRecordingStopped",n.fromuser=i,Ot(n);ao("ping")}else if("failed"==Ie[i].iceConnectionState){var n;if(Ie[i].inbps=0,Ie[i].outbps=0,Ie[i].closing=1,(n=JSON.parse("{}")).msgtype="EventFailed",n.fromuser=i,Ot(n),i==g)(n=JSON.parse("{}")).msgtype="EventRecordingStopped",n.fromuser=i,Ot(n)}},this.SendJSON=function(e){ao(e)},this.SendText=function(e){var t=JSON.parse(JSON.stringify(e));t.msgtype="text",ao(t)},this.SendInput=function(e){var t=JSON.parse(JSON.stringify(e));t.msgtype="onText",ao(t)},this.SendDTMF=function(e){for(var t in console.log("SendDTMF",e),Ie)if(Ie[t])for(var o=Ie[t].getSenders(),i=0;i<o.length;++i)o[i].dtmf&&o[i].dtmf.insertDTMF(e)},this.Send2WPhone=function(e){null!==pe&&1==pe.readyState&&(console.log("Send2WPhone",e),pe.send(JSON.stringify(e)))},this.JoinConference=function(o){if(!(ce||Se||$)){if(R)return console.log("JoinConference"),ee=null,te=0,ce=1,n=o.mgw,ve=o.chatroom,We||(We=new AudioMixer),(Ne=nt.captureStream()).addTrack(We.getAudioTrack()),ye=Se=Ne,ne=function(){var e=JSON.parse(JSON.stringify(l));e.msgtype="RequestJoinConference",e.chatroom=ve,e.fromuser=c,ao(e)},void oo();if(Xe.removeEventListener("mousedown",Xe.onMouseDown),Xe.removeEventListener("mousemove",Xe.onMouseMove),Xe.removeEventListener("mouseup",Xe.onMouseUp),Xe.removeEventListener("mouseout",Xe.onMouseUp),Xe.removeEventListener("ended",Xe.onEnded),Xe.addEventListener("mouseup",Xe.onMouseUp),Xe.addEventListener("ended",Xe.onEnded),l.rtmp)navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(e){console.log(e),Se=e,Ne||(Ne=nt.captureStream()).addTrack(Se.getAudioTracks()[0]);var t=JSON.parse(JSON.stringify(o));console.log("JoinConference"),console.log(t),n=t.mgw,a=o.wphone,ve=t.chatroom,ce=1,t.msgtype="RequestJoinConferenceEx",t.content=l.rtmp+t.fromuser,se=function(){le.Send2WPhone(t),se=null},ne=function(){le.SendJSON(t),ne=null},oo(),to(),Gt()}).catch(fo);else{if(!navigator.mediaDevices)return(o=JSON.parse("{}")).msgtype="EventVideoCallDisabled",o.useragent=navigator.userAgent,void ko(o);console.log("JoinConference"),ee=null,te=0,ce=1,h=l.retry,n=o.mgw,a=o.wphone,ve=o.chatroom,n||(n=l.mgw),a||(a=l.wphone),o.fromuser&&(c=o.fromuser),O=null==o.camera?0:parseInt(o.camera),o.turn&&(z="turn:"+o.turn),o.turnu&&(B=o.turnu),o.turnp&&(Y=o.turnp),Tt(),-1<O?(console.log("userAgent = ",navigator.userAgent),-1<navigator.userAgent.indexOf("Android")||-1<navigator.userAgent.indexOf("iPhone")?(Q=1==O?{audio:!0,video:{facingMode:{exact:"environment"}}}:{audio:!0,video:{facingMode:{exact:"user"}}},console.log(JSON.stringify(Q)),navigator.mediaDevices.getUserMedia(Q).then(Ht).catch(fo)):(2<O?navigator.mediaDevices.enumerateDevices().then(Wt).catch(fo):navigator.mediaDevices.enumerateDevices().then(Pt).catch(fo),navigator.mediaDevices.enumerateDevices().then(Lt).catch(fo))):-3==O?navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia({video:!0}).then(function(e){Ht(e)},fo):navigator.getDisplayMedia&&navigator.getDisplayMedia({video:!0}).then(function(e){Ht(e)},fo):(Ne=nt.captureStream(),1==d?Ht(Ne):navigator.mediaDevices.getUserMedia(Q).then(Ht).catch(fo)),(o=JSON.parse("{}")).msgtype="EventWindowOpened",o.fromuser=c,Ot(o),ne=function(){if("sbc"==X&&(ne=null),me)mo(me),me=-1;else{var e=JSON.parse(JSON.stringify(l));e.msgtype="RequestJoinConference",e.chatroom=ve,e.fromuser=c,ao(e)}}}}},this.StartMonitoringDesktop=function(e){ce||Se||$||!e||(console.log("StartMonitoringDesktop"),Ae||(Ae=new AudioMixer),I=s=1,n=e.mgw,a=e.wphone,ve=e.chatroom,(Se=nt.captureStream()).addTrack(Ae.getAudioTrack()),ne=function(){vo(ve,Se)},Gt(),oo())},this.StartMonitoring=function(t){Ie[t]||(console.log("StartMonitoring",t),ne=function(){ne=null;var e=JSON.parse("{}");e.msgtype="RequestStartMonitoring",e.fromuser=c,e.touser=t,ao(e)},de=function(o){de=null,console.log("onEventMonitorRinging "+o.fromuser+" "+o.chatroom);var e={iceServers:[{urls:z,username:B,credential:Y,credentialType:"password"}],iceTransportPolicy:"relay",sdpSemantics:"plan-b"},i=o.fromuser;co(i),Ie[i]=new RTCPeerConnection(e),Te[i]=o.chatroom,Ie[i].ontrack=function(e){po(i,e)},Ie[i].oniceconnectionstatechange=function(e){onIceConnectionStateChange(i),"disconnected"==this.iceConnectionState&&le.StopMonitoring(i)},Ie[i].setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:o.content})),Ie[i].createAnswer(function(e){e.sdp=e.sdp.replace("a=sendrecv\r\n","a=recvonly\r\n"),Ie[i].setLocalDescription(e),Ie[i].onicecandidate=function(e){if(null!==e.candidate&&0===e.candidate.sdpMLineIndex){var t=JSON.parse("{}");t.msgtype="RequestAnswerCall",t.fromuser=c,t.touser=o.fromuser,t.content=Ie[i].localDescription.sdp,ao(t)}}},fo)},n=e.mgw,Gt(),oo(),Xe.removeEventListener("mousedown",Xe.onMouseDown),Xe.removeEventListener("mousemove",Xe.onMouseMove),Xe.removeEventListener("mouseup",Xe.onMouseUp),Xe.removeEventListener("mouseout",Xe.onMouseUp),Xe.removeEventListener("ended",Xe.onEnded),Xe.addEventListener("mouseup",Xe.onMouseUp),Xe.addEventListener("ended",Xe.onEnded))},this.StopMonitoring=function(e){console.log("StopMonitoring",e),co(e);var t=JSON.parse("{}");t.msgtype="RequestStopMonitoring",t.fromuser=c,t.touser=e,ao(t),0==Object.keys(Ie).length&&le.Destroy(l)},this.RequestDisconnect=function(e){console.log("RequestDisconnect",e),co(e);var t=JSON.parse("{}");t.msgtype="RequestDisconnect",t.fromuser=c,t.touser=e,ao(t),0==Object.keys(Ie).length&&le.Destroy(l)},this.StartSharingDesktop=function(t){if(!(ce||Se||$)&&t){if(t.audiotrack||(Ae||(Ae=new AudioMixer),t.audiotrack=Ae.getAudioTrack()),!navigator.mediaDevices)return(t=JSON.parse("{}")).msgtype="EventVideoCallDisabled",t.useragent=navigator.userAgent,void Ot(t);console.log("StartSharingDesktop"),n=t.mgw,a=t.wphone,ve=t.chatroom,ne=function(){vo(ve,Se)},ae=function(){le.ChangeLayout("1")},re=function(e){(Se=e).addTrack(t.audiotrack),oo()},navigator.mediaDevices.enumerateDevices().then(So).catch(fo)}},this.LeaveConference=function(e){console.log("LeaveConference");var t=JSON.parse(JSON.stringify(e));t.msgtype=l.rtmp?"RequestLeaveConferenceEx":"RequestLeaveConference",ao(t),l.rtmp&&le.Send2WPhone(t),Promise.resolve().then(function(){for(var e in Ie)Ie[e]&&co(e)}),I=s=ge=ce=te=0,me=Be=ze=ee=ae=ne=null},this.LeaveConferenceEx=function(e){console.log("LeaveConferenceEx"),this.StopVPR(e),this.StopSharing(e),this.StopSharingHtml(e),this.StopSharingImage(e),this.StopSharingWindow(e),this.StopScrawling(e),this.StopAssistance(e),this.HideFloatingWindow(e),this.StopVideoPlaying(e),this.StopDoubleRecording(e),this.StopServerRecording(e),this.StopLocalRecording(e),this.StopDividedRecording(e),this.LeaveConference(e),this.StopUserMedia(e),(e=JSON.parse("{}")).msgtype="EventWindowClosed",e.fromuser=c,Ot(e)},this.Destroy=function(e){console.log("Destroy"),this.HideFloatingWindow(e),this.StopVPR(e),this.StopSharing(e),this.StopSharingHtml(e),this.StopSharingImage(e),this.StopScrawling(e),this.StopAssistance(e),this.HideFloatingWindow(e),this.StopVideoPlaying(e),this.StopDoubleRecording(e),this.StopServerRecording(e),this.StopLocalRecording(e),this.StopClientRecording(e),this.LeaveConference(e),this.StopUserMedia(e),this.CloseWS(),(e=JSON.parse("{}")).msgtype="EventWindowClosed",e.fromuser=c,Ot(e)},this.HoldCall=function(e){console.log("HoldCall");var t=JSON.parse(JSON.stringify(e));t.msgtype="RequestHoldCall",ao(t),ce=2},this.RetrieveCall=function(e){console.log("RetrieveCall");var t=JSON.parse(JSON.stringify(e));t.msgtype="RequestRetrieveCall",ao(t),ce=1},this.getDevices4SwitchCamera=function(e){console.log("gotDevices",e);for(var t=0,o={},i=0;i<e.length;++i){"default"!==e[i].deviceId&&("videoinput"===e[i].kind&&(console.log(e[i]),o[t]=e[i],t+=1))}console.log("totalCamera",t),console.log("videoDevices",o),O+=1,O%=t;var n={audio:!1,video:{}};n.video.deviceId={exact:o[O].deviceId},console.log(n),navigator.mediaDevices.getUserMedia(n).then(le.onGetStream4SwitchCamera).catch(fo)},this.onGetStream4SwitchCamera=function(e){if(1==l.imagemixer)return Se.getVideoTracks()[0].stop(),Se.addTrack(e.getVideoTracks()[0]),void(Dt.srcObject=e);Se.getVideoTracks()[0].stop(),Se.addTrack(e.getVideoTracks()[0]),(ye=e).addTrack(Se.getAudioTracks()[0]),Ie[c].video.srcObject=e,lo(Ie,e);var t=JSON.parse("{}");t.msgtype="EventLocalStream",t.fromuser=c,t.stream=e,Ot(t),ge&&(ue=ye.getVideoTracks()[0].label,he=ye.getAudioTracks()[0].label,console.log(ue,he),to())},this.SwitchCamera=function(e){if(Se)if(-1!=navigator.userAgent.indexOf("Android")||-1!=navigator.userAgent.indexOf("iPhone")){O+=1,O%=2;var t={audio:!1,video:{}};t.video=1==O?{facingMode:"environment"}:{facingMode:"user"},navigator.mediaDevices.getUserMedia(t).then(le.onGetStream4SwitchCamera).catch(fo)}else navigator.mediaDevices.enumerateDevices().then(le.getDevices4SwitchCamera).catch(fo)},this.DisableCamera=function(e){if(Se){console.log("DisableCamera");var t=JSON.parse(JSON.stringify(e));t.msgtype="RequestDisableCamera",ao(t);var o=setInterval(function(){for(var e in clearInterval(o),"fs"!=X&&Ie[c]&&Ie[c].video&&(Ie[c].video.hidden=1),Ie)if(Ie[e]){var t=Ie[e].video;t&&-1!=t.id.indexOf("LocalCamera")&&(t.hidden=1)}Se.getVideoTracks().forEach(function(e){e.enabled=!1})},500)}},this.EnableCamera=function(t){if(Se){for(var e in console.log("EnableCamera"),"fs"!=X&&Ie[c]&&Ie[c].video&&(Ie[c].video.hidden=0),Ie)if(Ie[e]){var o=Ie[e].video;o&&-1!=o.id.indexOf("LocalCamera")&&(o.hidden=0)}Se.getVideoTracks().forEach(function(e){e.enabled=!0});var i=setInterval(function(){clearInterval(i);var e=JSON.parse(JSON.stringify(t));e.msgtype="RequestEnableCamera",ao(e)},500)}},this.DisableMicphone=function(e){Se&&(console.log("DisableMicphone"),Se.getAudioTracks().forEach(function(e){console.log("DisableMicphone"),e.enabled=!1}))},this.EnableMicphone=function(e){Se&&(console.log("EnableMicphone"),Se.getAudioTracks().forEach(function(e){console.log("EnableMicphone"),e.enabled=!0}))},this.StopUserMedia=function(e){console.log("StopUserMedia"),je&&(clearInterval(je),je=null),Fe&&(clearInterval(Fe),Fe=null),Ue&&(clearInterval(Ue),Ue=null),we&&(we.stop(),we=null),Pe&&(clearInterval(Pe),Pe=null,Xe.srcObject=null,Xe.poster="avatar.png",Xe.posting=0),He&&(clearInterval(He),He=null),Se&&(Se.stop(),Se=null),xe&&(xe.stop(),xe=null),be&&(be.stop(),be=null),Ce&&(Ce.stop(),Ce=null),ke&&(ke.stop(),ke=null),Oe&&(Oe.stop(),Oe=null),ye&&(ye.stop(),ye=null),Ne&&(Ne.stop(),Ne=null),Je&&(Je.destroy(),Je=null),Ae&&(Ae.destroy(),Ae=null),We&&(We.destroy(),We=null),kt&&(Nt=null,(Ct=new TimelineDataSeries).setColor("blue"),kt.setDataSeries([Ct])),go()},this.StartSharingWindow=function(e){if(l.rtmp){console.log("StartSharingWindow");var t=JSON.parse("{}");t.msgtype="StartSharingWindow",t.chatroom=ve,t.fromuser=e,t.content=l.rtmp+c+"desktop",le.Send2WPhone(t),t.msgtype="RequestJoinConferenceEx",t.fromuser=c+"desktop",le.SendJSON(t)}},this.StopSharingWindow=function(e){if(l.rtmp){console.log("StopSharingWindow");var t=JSON.parse("{}");t.msgtype="StopSharingWindow",t.chatroom=ve,t.fromuser=c+"desktop",t.content=l.rtmp+c+"desktop",le.Send2WPhone(t),t.msgtype="RequestLeaveConferenceEx",le.SendJSON(t)}},this.RequestVisibleWindows=function(e){if(l.rtmp){console.log("RequestVisibleWindows");var t=JSON.parse("{}");t.msgtype="RequestVisibleWindows",t.chatroom=ve,t.fromuser=c+"desktop",le.Send2WPhone(t)}},this.OnEventEventVisibleWindows=function(e){if(l.rtmp){e.content=(new MyBase64).decode(e.content),console.log(e);var t=JSON.parse(e.content);console.log(t)}},this.StartSharing=function(e){Se&&(console.log("StartSharing"),0==J?(null==window.ShareScreenHandler&&(window.ShareScreenHandler=xo,window.addEventListener("message",xo)),window.peerConnections=Ie,window.postMessage("get-sourceId","*")):navigator.mediaDevices.getDisplayMedia?(window.peerConnections=Ie,navigator.mediaDevices.getDisplayMedia({video:!0}).then(function(e){wo(e)},yo)):navigator.getDisplayMedia?(window.peerConnections=Ie,navigator.getDisplayMedia({video:!0}).then(function(e){wo(e)},yo)):(null==window.ShareScreenHandler&&(window.ShareScreenHandler=xo,window.addEventListener("message",xo)),window.peerConnections=Ie,window.postMessage("get-sourceId","*")))},this.StopSharing=function(e){window.screenStream&&(console.log("StopSharing"),console.log(window.screenStream),Ie[c]&&Ie[c].video?Ie[c].video.srcObject=ye:Ie.LocalCamera2&&Ie.LocalCamera2.video&&(Ie.LocalCamera2.video.srcObject=Ie.LocalCamera2.stream),window.screenStream.stop(),delete window.screenStream,lo(Ie,ye),le.ChangeLayout(""),le.ChangeSpeaker(""))},this.PauseSharing=function(e){-3!=O?window.screenStream&&(console.log("PauseSharing"),window.screenStream.getVideoTracks().forEach(function(e){e.enabled=!1})):le.DisableCamera(e)},this.ResumeSharing=function(e){-3!=O?window.screenStream&&(console.log("ResumeSharing"),window.screenStream.getVideoTracks().forEach(function(e){e.enabled=!0})):le.EnableCamera(e)},this.StartSharingHtml=function(e){Se&&!_e&&(console.log("StartSharingHtml"),_e=setInterval(bo,200),De=it.captureStream(30),window.peerConnections=Ie,wo(De))},this.StopSharingHtml=function(e){_e&&(clearInterval(_e),_e=null),De&&(console.log("StopSharingHtml"),De.stop(),De=null)},this.ResumeServerRecording=function(e){(!Ie[g]||Ie[g].outbps<1)&&(le.StopServerRecording(e),le.StartServerRecording(e))},this.RestartServerRecording=function(e){le.StopServerRecording(e),le.StartServerRecording(e)},this.StartServerRecording=function(e){if(e?l=JSON.parse(JSON.stringify(e)):e=JSON.parse(JSON.stringify(l)),e&&1==e.pip&&(D=1),f=null==e.maxbps4recording?0:parseInt(e.maxbps4recording),l.rtmp){for(var t in console.log("StartServerRecording"),Je&&Je.destroy(),Je=new AudioMixer,be=e&&1==e.pip?Qe.captureStream(w):tt.captureStream(w),Ie)if(Ie[t]){var o=Ie[t].stream;o&&(t==c?1==l.audiomixer?Je.addAudioSource(t,o):be.addTrack(o.getAudioTracks()[0]):Je.addAudioSource(t,o))}return be.addTrack(Je.getAudioTrack()),void vo(g,be)}!be&&Se&&(console.log("StartServerRecording"),be=e&&1==e.pip?Qe.captureStream(w):tt.captureStream(w),Je||(Je=new AudioMixer),be.addTrack(Je.getAudioTrack()),0==l.audiomixer&&be.addTrack(Se.getAudioTracks()[0]),vo(g,be))},this.StopServerRecording=function(e){if(be){console.log("StopServerRecording"),e||(e=l);var t=JSON.parse(JSON.stringify(e));t.msgtype="RequestReleaseCall",t.chatroom=ve,t.fromuser=c,t.touser=g,ao(t),co(g),xe&&(xe.stop(),xe=null),be&&be.getTracks().forEach(function(e){console.log("removeTrack "+e.kind+" "+e.label),be.removeTrack(e)}),be&&(be.stop(),be=null)}},this.StartDoubleRecording=function(e){$||xe||be||!Se||(console.log("StartDoubleRecording"),le.StartServerRecording(e),le.StartClientRecording(e))},this.StopDoubleRecording=function(e){console.log("StopDoubleRecording"),le.StopClientRecording(e),le.StopServerRecording(e)},this.StartServerVideoRecording=function(e){if(e&&(l=JSON.parse(JSON.stringify(e))),ze&&ze!=c){var t=Ie[ze].audio;o=Ie[ze].video;if(!t||!o)return;(be=o.srcObject.clone()).addTrack(t.srcObject.getAudioTracks()[0])}else{var o;if(!(o=Ie[c].video))return;(be=o.srcObject.clone()).addTrack(Se.getAudioTracks()[0])}console.log("StartServerVideoRecording"),vo(g,be)},this.StartClientVideoRecording=function(e){if(!K&&Se){if(ze&&ze!=c){var t=Ie[ze].audio;o=Ie[ze].video;if(!t||!o)return;(xe=o.srcObject.clone()).addTrack(t.srcObject.getAudioTracks()[0])}else{var o;if(!(o=Ie[c].video))return;(xe=o.srcObject.clone()).addTrack(Se.getAudioTracks()[0])}console.log("StartClientVideoRecording");var i=e&&e.filename?e.filename:c+"_"+(new Date).getTime()+".mp4";(K=RecordRTC(xe,{type:"video",mimeType:"video/mp4",disableLogs:!1,getNativeBlob:!1})).setFileName(i),K.startRecording()}},this.StartDividedRecording=function(e){console.log("StartDividedRecording");var t={type:"video",mimeType:"video/mp4",disableLogs:!1,getNativeBlob:!1};for(var o in Ie)if(Ie[o]){var i=o+"_"+(new Date).getTime()+".mp4",n=Ie[o].video.srcObject.clone();Ee[o]=new RecordRTC(n,t),Ee[o].stream=n,Ee[o].setFileName(i),Ee[o].startRecording()}},this.StopDividedRecording=function(e){for(var t in console.log("StopDividedRecording"),Ie){var o=Ee[t];o&&(o.stream&&(o.stream.stop(),o.stream=null),o.stopRecording(function(e,t){window.open(e)}),delete Ee[t])}},this.StartClientRecording=function(e){if(!K&&Se){console.log("StartClientRecording");var t=e&&e.filename?e.filename:c+"_"+(new Date).getTime()+".mp4",o={type:"video",mimeType:"video/mp4",disableLogs:!1,getNativeBlob:!1};e.mimetype?o.mimeType=e.mimetype:o.mimetype="video/webm;codecs=h264",xe=e&&1==e.pip?Qe.captureStream(w):tt.captureStream(w),Ae||(Ae=new AudioMixer),xe.addTrack(Ae.getAudioTrack()),(K=RecordRTC(xe,o)).setFileName(t),K.startRecording()}},this.StopClientRecording=function(e){K&&(console.log("StopClientRecording"),K.stopRecording(function(e,t){K.save();var o=JSON.parse("{}");o.msgtype="EventLocalRecordInfo",o.recordfileurl=e,o.filename=t,o.fromuser=c,Ot(o),K=null})),xe&&(xe.stop(),xe=null)},this.PauseClientRecording=function(e){K&&(console.log("PauseClientRecording"),K.pauseRecording())},this.ResumeClientRecording=function(e){K&&(console.log("ResumeClientRecording"),K.resumeRecording())},this.StartLocalRecording=function(e){if(!$&&!Se){if(!navigator.mediaDevices)return(e=JSON.parse("{}")).msgtype="EventVideoCallDisabled",e.useragent=navigator.userAgent,void ko(e);console.log("StartLocalRecording"),navigator.mediaDevices.enumerateDevices().then(Co).catch(fo)}},this.StopLocalRecording=function(e){if($)for(var t in console.log("StopLocalRecording"),$.stopRecording(function(e,t){$.save();var o=JSON.parse("{}");o.msgtype="EventLocalRecordInfo",o.recordfileurl=e,o.filename=t,o.fromuser=c,Ot(o),$=null}),this.StopUserMedia(),Ie)Ie[t]&&co(t)},this.PauseRecording=function(e){$&&(console.log("PauseRecording"),$.pauseRecording())},this.ResumeRecording=function(e){$&&(console.log("ResumeRecording"),$.resumeRecording())},this.StartSharingImage=function(e){!le.streamSharing&&Se&&(console.log("StartSharingImage"),le.canvasSharing=document.createElement("canvas"),le.ctxSharing=le.canvasSharing.getContext("2d"),le.canvasSharing.width=e.width,le.canvasSharing.height=e.height,le.streamSharing=le.canvasSharing.captureStream(),le.timerSharing=setInterval(function(){le.ctxSharing.drawImage(e,0,0,e.width,e.height)},100),lo(Ie,le.streamSharing))},this.StopSharingImage=function(){le.streamSharing&&Se&&(console.log("StopSharingImage"),le.streamSharing.stop(),clearInterval(le.timerSharing),delete le.timerSharing,delete le.streamSharing,delete le.ctxSharing,delete le.canvasSharing,lo(Ie,ye))},this.HidePeerVideo=function(e){console.log("HidePeerVideo",e.fromuser),Ie[e.fromuser]&&Ie[e.fromuser].video&&(Ie[e.fromuser].video.hidden=1)},this.ShowPeerVideo=function(e){console.log("ShowPeerVideo",e.fromuser),Ie[e.fromuser]&&Ie[e.fromuser].video&&(Ie[e.fromuser].video.hidden=0)},this.FreezePeerVideo=function(e){console.log("FreezePeerVideo",e.fromuser),Ie[e.fromuser]&&Ie[e.fromuser].video&&Ie[e.fromuser].video.pause()},this.UnfreezePeerVideo=function(e){console.log("UnfreezePeerVideo",e.fromuser),Ie[e.fromuser]&&Ie[e.fromuser].video&&Ie[e.fromuser].video.play()},this.SetMainPeer=function(e){console.log("SetMainPeer",e.fromuser),ze=e.fromuser},this.SetVolume=function(e){for(var t in console.log("SetVolume",e),e<0?e=0:1<e&&(e=1),Ie)if(Ie[t]&&t!=c){var o=Ie[t].audio;o&&(o.volume=e,console.log(t,o.volume))}for(var t in Ie)if(Ie[t]&&t!=c){var i=Ie[t].video;i&&(i.volume=e,console.log(t,i.volume))}},$e&&($e.onLoadedMetaData=function(){console.log("size:"+this.videoWidth+"x"+this.videoHeight),0!=this.videoWidth&&0!=this.videoHeight||($e.mixed=0),ke=$e.captureStream(w),We||(We=new AudioMixer),Je||(Je=new AudioMixer),0==R&&(We.addAudioSource(c,Se),Je.addAudioSource(c,Se)),We.addAudioSource("mp4player",ke),Je.addAudioSource("mp4player",ke),lo(Ie,ke),function(e,t){for(var o in e)if(e[o]&&!(o==c||o==g||-1<o.toLowerCase().indexOf("recorder")))for(var i=e[o].getSenders(),n=0;n<i.length;++n)if("audio"===i[n].track.kind){console.log(i[n]),i[n].replaceTrack(t);break}}(Ie,We.getAudioTrack()),function(e,t){for(var o in e)if(e[o]&&(o==g||-1!=o.toLowerCase().indexOf("recorder")))for(var i=e[o].getSenders(),n=0;n<i.length;++n)if("audio"===i[n].track.kind){console.log(i[n]),i[n].replaceTrack(t);break}}(Ie,Je.getAudioTrack())}),this.StartVideoPlaying=function(e){e&&e.content&&Se&&(0!=e.mixed&&(e.mixed=1),e.content.endsWith(".pdf")||e.content.endsWith(".PDF")?Ke&&(console.log("StartPdfPlaying"),Ke.style="display: block",Ke.src=e.content):$e&&(console.log("StartVideoPlaying"),$e.style="display: block",$e.src=e.content,$e.mixed=parseInt(e.mixed),$e.removeEventListener("loadedmetadata",$e.onLoadedMetaData),$e.addEventListener("loadedmetadata",$e.onLoadedMetaData)))},this.StopVideoPlaying=function(e){Ke&&(console.log("StopPdfPlaying"),Ke.style="display: none",Ke.src=""),$e&&(console.log("StopVideoPlaying"),$e.style="display: none",$e.src="",$e.removeEventListener("loadedmetadata",$e.onLoadedMetaData)),null!=ke&&($e.mixed=0,ke.stop(),ke=null,lo(Ie,ye))},this.MakeCall=function(e){ro(e)},this.GetState=function(e){var t=JSON.parse(JSON.stringify(e));null!=fe&&1==fe.readyState&&null!=pe&&1==pe.readyState?t.msgtype="EventReady":t.msgtype="EventNotReady",le.Send2WPhone(t)},this.GetTotalPeers=function(e){var t=0;for(var o in Ie)o==c||o==g||-1<o.toLowerCase().indexOf("recorder")||-1<o.toLowerCase().indexOf("localcamera")||(console.log(o),t+=1);return t},this.GetAudioTrack=function(){return Ae||(Ae=new AudioMixer),Ae.getAudioTrack()},this.ChangeDrawingMode=function(e){-1!=C&&(C+=1,C%=3,console.log("ChangeDrawingMode",C))},this.ShowFloatingWindow=function(e){console.log("ShowFloatingWindow"),Xe.disablePictureInPicture=!1,Xe.requestPictureInPicture()},this.HideFloatingWindow=function(e){console.log("HideFloatingWindow"),Xe.disablePictureInPicture=!0},this.StartScrawling=function(e){null!=e.linewidth&&null!=e.linewidth&&(F=parseInt(e.linewidth)),null!=e.linetype&&null!=e.linetype&&(U=parseInt(e.linetype)),null!=e.linecolor&&null!=e.linecolor&&(_=e.linecolor),null!=e.samecolor&&null!=e.samecolor&&(q=parseInt(e.samecolor)),Xe.onscrawling||null==Se||(pt=[],Xe.controls="",Xe.onscrawling=!0,Xe.removeEventListener("mousedown",Xe.onMouseDown),Xe.removeEventListener("mousemove",Xe.onMouseMove),Xe.removeEventListener("mouseup",Xe.onMouseUp),Xe.removeEventListener("mouseout",Xe.onMouseUp),Xe.addEventListener("mousedown",Xe.onMouseDown),Xe.addEventListener("mousemove",Xe.onMouseMove),Xe.addEventListener("mouseup",Xe.onMouseUp),Xe.addEventListener("mouseout",Xe.onMouseUp),lo(Ie,we))},this.StopScrawling=function(e){Xe.onscrawling&&(Xe.removeEventListener("mousedown",Xe.onMouseDown),Xe.removeEventListener("mousemove",Xe.onMouseMove),Xe.removeEventListener("mouseout",Xe.onMouseUp),pt=[],Xe.onscrawling=null,Xe.controls="controls",lo(Ie,ye))},this.UndoScrawling=function(e){if(Xe.onscrawling){for(pt.pop();0<pt.length&&null!=pt.pop(););pt.push(null)}},this.StartAssistance=function(e){if(null!=e.linewidth&&null!=e.linewidth&&(F=parseInt(e.linewidth)),null!=e.linetype&&null!=e.linetype&&(U=parseInt(e.linetype)),null!=e.linecolor&&null!=e.linecolor&&(_=e.linecolor),null!=e.samecolor&&null!=e.samecolor&&(q=parseInt(e.samecolor)),!Xe.onassistance&&null!=Se){Xe.controls="",Xe.onassistance=!0,Xe.removeEventListener("mousedown",Xe.onMouseDown),Xe.removeEventListener("mousemove",Xe.onMouseMove),Xe.removeEventListener("mouseup",Xe.onMouseUp),Xe.removeEventListener("mouseout",Xe.onMouseUp),Xe.addEventListener("mousedown",Xe.onMouseDown),Xe.addEventListener("mousemove",Xe.onMouseMove),Xe.addEventListener("mouseup",Xe.onMouseUp),Xe.addEventListener("mouseout",Xe.onMouseUp),Ie[c]&&Ie[c].video&&(Ie[c].video.hidden=1);var t=JSON.parse("{}");t.msgtype="EventStartAssistance",t.fromuser=c,t.chatroom=ve,ao(t)}},this.StopAssistance=function(e){if(Xe.onassistance){Xe.onassistance=null,Xe.controls="controls",Xe.removeEventListener("mousedown",Xe.onMouseDown),Xe.removeEventListener("mousemove",Xe.onMouseMove),Xe.removeEventListener("mouseout",Xe.onMouseUp),Ie[c]&&Ie[c].video&&(Ie[c].video.hidden=0);var t=JSON.parse("{}");t.msgtype="EventStopAssistance",t.fromuser=c,t.chatroom=ve,ao(t)}},this.ChangeSpeaker=function(e){var t=JSON.parse("{}");t.msgtype="ChangeSpeaker",t.chatroom=ve,t.fromuser=e||c,t.touser=t.fromuser,ao(t)},this.ClearSpeaker=function(){var e=JSON.parse("{}");e.msgtype="ClearSpeaker",e.chatroom=ve,e.fromuser=c,ao(e)},this.ChangeLayout=function(e){var t=JSON.parse("{}");t.msgtype="ChangeLayout",t.chatroom=ve,t.fromuser=c,t.content=e,ao(t)},this.ChangeWidthHeight=function(e){var t=JSON.parse("{}");t.msgtype="ChangeWidthHeight",t.chatroom=ve,t.fromuser=c,t.content=e,ao(t)},this.ShowMyVideo=function(){var e=JSON.parse("{}");e.msgtype="ShowMyVideo",e.chatroom=ve,e.fromuser=c,ao(e)},this.HideMyVideo=function(){var e=JSON.parse("{}");e.msgtype="HideMyVideo",e.chatroom=ve,e.fromuser=c,ao(e)},this.SetVirtualBackground=function(e){if(e){console.log("SetVirtualBackground",e);try{var t=new Image;t.src=e,t.onload=function(){It=t}}catch(e){fo(e)}}},this.SetFontColor=function(e,t){e&&(V=e),t&&(j=t)},this.Debug=function(e){T=e,"undefined"==typeof VConsole||1!=T||t||(t=new VConsole),t&&0==T&&(t.destroy(),t=null)},this.ChangeSettings=function(e){if(Se){if(e.pipscale&&(y=parseFloat(e.pipscale)),e.portrait&&(x=parseInt(e.portrait)),e.showpaused&&(b=parseInt(e.showpaused)),e.autoleave&&(I=parseInt(e.autoleave)),e.statinfo&&(E=parseInt(e.statinfo)),e.autoreg&&(M=parseInt(e.autoreg)),e.debug&&(T=parseInt(e.debug)),e.delayrecord&&parseInt(e.delayrecord),e.sharingmode&&(J=parseInt(e.sharingmode)),e.password&&(A=e.password),e.logoratio&&(W=parseFloat(e.logoratio)),e.logopos&&(L=e.logopos),e.textlogo&&(H=e.textlogo),e.textpos&&(P=e.textpos),e.textfont&&(V=e.textfont),e.textcolor&&(j=e.textcolor),e.imagelogo?(mt=new Image).src=e.imagelogo:mt=null,null!=e.maxbps)for(var t in console.log(ye.getVideoTracks()[0]),Ie)if(Ie[t]&&t!=c&&t!=g&&!(-1<t.toLowerCase().indexOf("recorder")))for(var o=Ie[t].getSenders(),i=0;i<o.length;++i){console.log(o[i]);var n=o[i].getParameters();n.encodings&&n.encodings[0]||(n.encodings=[{}]),0==e.maxbps?delete n.encodings[0].maxBitrate:n.encodings[0].maxBitrate=1e3*parseInt(e.maxbps),o[i].setParameters(n)}if(e.maxheight&&(v=parseInt(e.maxheight)),e.framerate&&(w=parseInt(e.framerate)),null!=e.showtime&&(D=parseInt(e.showtime)),e.maxheight&&Se)if(1==x){var a={height:{exact:v},frameRate:w,advanced:[{aspectRatio:.75}]};console.log("loadMediaConstrains"),console.log(a),Se.getVideoTracks()[0].applyConstraints(a)}else{a={height:{max:v},frameRate:w};console.log("loadMediaConstrains"),console.log(a),Se.getVideoTracks()[0].applyConstraints(a)}null!=e.imagemixer&&e.imagemixer!=l.imagemixer&&Se&&!window.screenStream&&(l.imagemixer=e.imagemixer,ye!=Se&&ye.getVideoTracks().forEach(function(e){e.stop()}),0==l.imagemixer?(Ie[c]&&Ie[c].video&&(Ie[c].video.srcObject=Se),ye=Se):(Dt.srcObject=Se,(ye=ot.captureStream()).addTrack(Se.getAudioTracks()[0]),Ie[c]&&Ie[c].video&&(Ie[c].video.srcObject=ye),2<O&&(Ie.LocalCamera2.video.srcObject=ye)),lo(Ie,ye))}},this.ChangeNetwork=function(e){var t=JSON.parse("{}");t.msgtype="ChangeNetwork",t.chatroom=ve,t.fromuser=c,t.content=e,ao(t)},this.ChangeBandwidth=function(e){var t=JSON.parse("{}");t.msgtype="ChangeBandwidth",t.chatroom=ve,t.fromuser=c,t.content=e,ao(t)},this.ChangeFPS=function(e){var t=JSON.parse("{}");t.msgtype="ChangeFPS",t.chatroom=ve,t.fromuser=c,t.content=e,ao(t)},this.ConferenceDial=function(e){var t=JSON.parse("{}");t.msgtype="ConferenceDial",t.chatroom=ve,t.fromuser=c,t.touser=e,ao(t)},this.ResetWS=function(){try{null!==fe&&1==fe.readyState&&(console.log("ResetWS"),fe.close(),fe=null)}catch(e){console.log("ResetWS",e)}},this.CloseWS=function(e){Le&&(clearInterval(Le),Le=null),Ve&&(clearInterval(Ve),Ve=null),null!==fe&&1==fe.readyState&&(console.log("ws.close",n),n=null,fe.close(),fe=null),null!==pe&&1==pe.readyState&&(console.log("ws.close",a),a=null,pe.close(),pe=null),window.networkHandler&&(window.removeEventListener("offline",window.networkHandler),window.networkHandler=null),Xe&&Xe.removeEventListener&&(Xe.removeEventListener("mousedown",Xe.onMouseDown),Xe.removeEventListener("mousemove",Xe.onMouseMove),Xe.removeEventListener("mouseup",Xe.onMouseUp),Xe.removeEventListener("mouseout",Xe.onMouseUp),Xe.removeEventListener("ended",Xe.onEnded))},this.TakePhoto=function(e,t,o){null!=e&&null!=e||(e=1),null!=o&&null!=o||(o=.5);var i=Xe;if(t&&Ie[t]&&Ie[t].video)i=Ie[t].video,console.log("TakePhoto",i.id);else if(Be)i=Ie[Be].video,console.log("TakePhoto",i.id);else for(var t in Ie)if(t&&t!=c&&Ie[t]&&Ie[t].video){i=Ie[t].video,console.log("TakePhoto",i.id);break}var n=document.createElement("canvas");return n.width=i.videoWidth*o,n.height=i.videoHeight*o,n.getContext("2d").drawImage(i,0,0,n.width,n.height),n.toDataURL("image/png",e)},this.TakePhotoEx=function(e){var t=e?JSON.parse(JSON.stringify(e)):JSON.parse("{}");t.msgtype="RequestTakePhotoEx",t.chatroom=ve,t.fromuser=c,ao(t)},this.TakeFace=function(s,d){if(Xe.srcObject){null==s&&(s=.5);var l=(new Date).getTime()+3e3;g_timerTracker=setInterval(function(){var e=Xe;d&&Ie[d]&&Ie[d].video&&(e=Ie[d].video);var i=document.createElement("canvas"),n=i.getContext("2d");i.width=.5*e.videoWidth,i.height=.5*e.videoHeight,n.drawImage(e,0,0,i.width,i.height);var t=i.toDataURL("image/jpeg",.5),a=document.createElement("img");a.src=t,a.onload=function(){var e=new tracking.ObjectTracker(["face"]);e.setInitialScale(4),e.setStepSize(2),e.setEdgesDensity(.1),tracking.track(a,e),e.on("track",function(e){if(0<e.data.length){clearInterval(g_timerTracker),g_timerTracker=null;var t=e.data[0];i.width=t.width,i.height=t.height,n.drawImage(a,t.x-5,t.y-10,t.width+10,t.height+20,0,0,t.width,t.height);var o=JSON.parse("{}");o.msgtype="EventFaceTaken",o.fromuser=d,o.face=i.toDataURL("image/jpeg",s),Ot(o)}})};var o=(new Date).getTime();if(l<o){clearInterval(g_timerTracker),g_timerTracker=null;var r=JSON.parse("{}");r.msgtype="EventFaceTaken",r.fromuser=d,r.face=t,Ot(r)}},100)}},this.SelfCheck=function(e){if(console.log("SelfCheck",e),Ge=e?1e3*e:3e3,!document.createElement("canvas").captureStream||!navigator.mediaDevices){var t=JSON.parse("{}");return t.msgtype="EventVideoCallDisabled",t.useragent=navigator.userAgent,void ko(t)}navigator.mediaDevices.enumerateDevices().then(No).catch(Oo)},this.GetCamerasInfo=function(e){if(console.log("GetCamerasInfo"),!document.createElement("canvas").captureStream||!navigator.mediaDevices)return(e=JSON.parse("{}")).msgtype="EventVideoCallDisabled",e.useragent=navigator.userAgent,void ko(e);navigator.mediaDevices.enumerateDevices().then(Io).catch(Oo)},this.CameraTest=function(e){if(!(ce||Se||$)){if(!navigator.mediaDevices)return(e=JSON.parse("{}")).msgtype="EventVideoCallDisabled",e.useragent=navigator.userAgent,void ko(e);console.log("CameraTest"),O=0,ge=1,a=e.wphone,navigator.mediaDevices.getUserMedia(Q).then(Ro).catch(fo),(e=JSON.parse("{}")).msgtype="EventWindowOpened",e.fromuser=c,Ot(e),se=function(){var e=JSON.parse("{}");e.msgtype="RequestNotifyDeviceInfo",e.fromuser=c,e.camera=ue,e.camera=e.camera.replace("默认 - ",""),e.micphone=he,e.micphone=e.micphone.replace("默认 - ",""),-1<e.camera.lastIndexOf(":")&&-1<e.camera.lastIndexOf(" ")&&(e.camera=e.camera.substring(0,e.camera.lastIndexOf(" "))),-1<e.camera.lastIndexOf(":")&&-1<e.micphone.lastIndexOf(" ")&&(e.micphone=e.micphone.substring(0,e.micphone.lastIndexOf(" "))),le.Send2WPhone(e)}}},this.StartVPR=function(e){"undefined"==typeof tracking||Se||Z||(console.log("StartVPR"),bt=null,navigator.mediaDevices.getUserMedia(Q).then(Eo).catch(fo))},this.StopVPR=function(e){Z&&(console.log("StopVPR"),Z.stopRecording(function(e,t){var o=JSON.parse("{}");o.msgtype="EventVPR",o.fromuser=c,o.content=e,o.face=bt,Ot(o),Z=null}),g_timerTracker&&(clearInterval(g_timerTracker),g_timerTracker=null),Se&&(Xe.srcObject=null,Se.stop(),Se=null),Xe.laststyle&&(Xe.style=Xe.laststyle,Xe.laststyle=null),yt&&(Xe.parentNode&&yt.parentNode.removeChild(yt),xt=yt=null))}}function AudioMixer(){this.audioCtx=new AudioContext,this.audioDestination=this.audioCtx.createMediaStreamDestination(),this.audioStream=this.audioDestination.stream,this.audioNodes=[],AudioMixer.prototype.addAudioSource=function(e,t,o){this.removeAudioSource(e),this.audioNodes[e]=JSON.parse("{}"),this.audioNodes[e].audio=o,this.audioNodes[e].stream=t,this.audioNodes[e].audioSource=this.audioCtx.createMediaStreamSource(t),this.audioNodes[e].audioGain=this.audioCtx.createGain(),this.audioNodes[e].audioGain.gain.value=1,o&&(o.audioGain=this.audioNodes[e].audioGain,this.audioNodes[e].audioSource.connect(this.audioDestination),o.onvolumechange=function(e){console.log("onvolumechange",this.volume),this.audioGain.gain.value=this.volume}),this.audioNodes[e].audioSource.connect(this.audioNodes[e].audioGain),this.audioNodes[e].audioGain.connect(this.audioDestination)},AudioMixer.prototype.addElementSource=function(e,t){this.removeAudioSource(e),this.audioNodes[e]=JSON.parse("{}"),this.audioNodes[e].audio=t,this.audioNodes[e].audioSource=this.audioCtx.createMediaElementSource(t),this.audioNodes[e].audioGain=this.audioCtx.createGain(),this.audioNodes[e].audioGain.gain.value=1,t&&(t.audioGain=this.audioNodes[e].audioGain,this.audioNodes[e].audioSource.connect(this.audioDestination),t.onvolumechange=function(e){console.log("onvolumechange",this.volume),this.audioGain.gain.value=this.volume}),this.audioNodes[e].audioSource.connect(this.audioNodes[e].audioGain),this.audioNodes[e].audioGain.connect(this.audioDestination)},AudioMixer.prototype.removeAudioSource=function(e){this.audioNode&&this.audioNodes[e]&&(this.audioNodes[e].audio&&(this.audioNodes[e].audio.onvolumechange=null,this.audioNodes[e].audio.srcObject=null,this.audioNodes[e].audio=null),this.audioNodes[e].stream&&(this.audioNodes[e].stream.stop(),this.audioNodes[e].stream=null),this.audioNodes[e].audioSource&&this.audioNodes[e].audioSource.mediaStream&&(this.audioNodes[e].audioSource.mediaStream.stop(),this.audioNodes[e].audioSource.mediaStream=null),this.audioNodes[e].audioSource=null,this.audioNodes[e].audioGain=null,this.audioNodes[e]=null,delete this.audioNodes[e])},AudioMixer.prototype.getAudioTrack=function(){return this.audioStream?this.audioStream.getTracks()[0].clone():null},AudioMixer.prototype.destroy=function(){if(this.audioNodes)for(var e in this.audioNodes)this.removeAudioSource(e);this.audioStream&&this.audioStream.stop(),this.audioCtx&&this.audioCtx.close(),this.audioCtx=null,this.audioStream=null,this.audioDestination=null,this.audioNodes=[]}}function SoundMeter(e,t){var a=this;a.callback=t,a.buffer_size=125,a.buffer=new Array(a.buffer_size),a.sample=0,a.inited=!1,a.audioCtx=new AudioContext,a.analyser=a.audioCtx.createAnalyser(),a.micphone=a.audioCtx.createMediaStreamSource(e),a.javascriptNode=a.audioCtx.createScriptProcessor(2048,1,1),a.analyser.smoothingTimeConstant=.8,a.analyser.fftSize=1024,a.micphone.connect(a.analyser),a.analyser.connect(a.javascriptNode),a.javascriptNode.connect(a.audioCtx.destination),a.javascriptNode.onaudioprocess=function(){var e=new Uint8Array(a.analyser.frequencyBinCount);a.analyser.getByteFrequencyData(e);for(var t=0,o=e.length,i=0;i<o;++i)t+=e[i];var n=t/o;console.log(n),n>window.soundLevel&&(window.soundLevel=n),a.callback&&a.callback(n),a.inited?(a.buffer=a.buffer.slice(1),a.buffer.push(n)):a.buffer[a.sample++]=n,!a.inited&&a.sample>a.buffer_size&&(a.sample=0,a.inited=!0)},SoundMeter.prototype.destroy=function(){a.javascriptNode.onaudioprocess=null,a.audioCtx.close(),a.audioCtx=null,a.analyser=null,a.micphone=null,a.javascriptNode=null}}function MyBase64(){_keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",this.encode=function(e){var t,o,i,n,a,r,s,d="",l=0;for(e=_utf8_encode(e);l<e.length;)n=(t=e.charCodeAt(l++))>>2,a=(3&t)<<4|(o=e.charCodeAt(l++))>>4,r=(15&o)<<2|(i=e.charCodeAt(l++))>>6,s=63&i,isNaN(o)?r=s=64:isNaN(i)&&(s=64),d=d+_keyStr.charAt(n)+_keyStr.charAt(a)+_keyStr.charAt(r)+_keyStr.charAt(s);return d},this.decode=function(e){var t,o,i,n,a,r,s="",d=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");d<e.length;)t=_keyStr.indexOf(e.charAt(d++))<<2|(n=_keyStr.indexOf(e.charAt(d++)))>>4,o=(15&n)<<4|(a=_keyStr.indexOf(e.charAt(d++)))>>2,i=(3&a)<<6|(r=_keyStr.indexOf(e.charAt(d++))),s+=String.fromCharCode(t),64!=a&&(s+=String.fromCharCode(o)),64!=r&&(s+=String.fromCharCode(i));return s=_utf8_decode(s)},_utf8_encode=function(e){e=e.replace(/\r\n/g,"\n");for(var t="",o=0;o<e.length;o++){var i=e.charCodeAt(o);i<128?t+=String.fromCharCode(i):(127<i&&i<2048?t+=String.fromCharCode(i>>6|192):(t+=String.fromCharCode(i>>12|224),t+=String.fromCharCode(i>>6&63|128)),t+=String.fromCharCode(63&i|128))}return t},_utf8_decode=function(e){for(var t="",o=0,i=c1=c2=0;o<e.length;)(i=e.charCodeAt(o))<128?(t+=String.fromCharCode(i),o++):191<i&&i<224?(c2=e.charCodeAt(o+1),t+=String.fromCharCode((31&i)<<6|63&c2),o+=2):(c2=e.charCodeAt(o+1),c3=e.charCodeAt(o+2),t+=String.fromCharCode((15&i)<<12|(63&c2)<<6|63&c3),o+=3);return t}}String.getGUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},String.url2json=function(){var e=window.location.href,t=e.substring(e.lastIndexOf("?")+1),a={};return t.replace(/([^?&=]+)=([^?&=]*)/g,function(e,t,o){var i=decodeURIComponent(t),n=decodeURIComponent(o);return n=String(n),a[i]=n,e}),a},String.getParam=function(e,t,o){var i=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=window.location.search.substr(1).match(i);return null!==n?o?parseInt(unescape(n[2])):unescape(n[2]):t},String.format=function(e,t){return(Array(t).join("0")+e).slice(-t)},String.formatd=function(e,t){return(Array(t).join(" ")+e).slice(-t)},Date.prototype.format=function(){var e=this.getFullYear();return e+="-",e+=String.format(this.getMonth()+1,2),e+="-",e+=String.format(this.getDate(),2),e+=" ",e+=String.format(this.getHours(),2),e+=":",e+=String.format(this.getMinutes(),2),e+=":",e+=String.format(this.getSeconds(),2)},Date.prototype.Format=function(){var e=this.getFullYear();return e+="-",e+=String.format(this.getMonth()+1,2),e+="-",e+=String.format(this.getDate(),2),e+=" ",e+=String.format(this.getHours(),2),e+=":",e+=String.format(this.getMinutes(),2),e+=":",e+=String.format(this.getSeconds(),2),e+=".",e+=String.format(this.getMilliseconds(),3)};